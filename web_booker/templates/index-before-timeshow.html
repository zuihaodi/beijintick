<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—å¤–ä½“è‚²é¦†å¯è§†æŠ¢ç¥¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f7;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 120px;
        }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .clock {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .btn-manage {
            background: #5856d6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* æ—¥æœŸé€‰æ‹© */
        .date-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .date-btn {
            flex: 0 0 auto;
            padding: 10px 15px;
            border: none;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: 0.2s;
        }

        .date-btn.active {
            background: #007aff;
            color: white;
            font-weight: bold;
        }

        /* çŸ©é˜µ */
        .matrix-container {
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 600px;
        }

        th,
        td {
            padding: 8px;
            text-align: center;
            border: 1px solid #eee;
        }

        th {
            background: #fafafa;
            color: #666;
            font-size: 14px;
        }

        /* çŠ¶æ€æ ¼å­ */
        .cell {
            width: 40px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
            margin: 0 auto;
        }

        .cell.available {
            background-color: #34c759;
        }

        .cell.booked {
            background-color: #ff3b30;
            cursor: not-allowed;
            opacity: 0.3;
        }

        .cell.selected {
            background-color: #007aff;
            box-shadow: 0 0 0 2px #0056b3 inset;
            transform: scale(0.9);
        }

        /* å·²é€‰æ ‡ç­¾ */
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            max-height: 80px;
            overflow-y: auto;
        }

        .tag {
            background: #e3f2fd;
            color: #007aff;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .tag-close {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.6;
        }

        .tag-close:hover {
            opacity: 1;
            color: #ff3b30;
        }

        /* åº•éƒ¨æ  */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .bar-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .info {
            font-size: 16px;
            font-weight: bold;
        }

        .timer-box {
            background: #f0f0f5;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .timer-input {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            width: 80px;
            font-family: monospace;
        }

        .btn {
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-danger {
            background: #ff3b30;
            color: white;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-title {
            font-weight: bold;
            font-size: 18px;
        }

        .modal-close {
            cursor: pointer;
            font-size: 20px;
            color: #999;
        }

        .task-form {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-item {
            background: white;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-info {
            font-size: 14px;
        }

        .task-meta {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .btn-del {
            color: #ff3b30;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        /* æ–°å¢ï¼šå¼¹çª—å†…çš„æ ‡ç­¾é€‰æ‹©å™¨ */
        .tag-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .tag-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            color: #333;
            transition: 0.2s;
        }

        .tag-btn.active {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }

        /* æ–°å¢ Tab æ ·å¼ */
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: 0.2s;
        }

        .tab-btn:hover {
            color: #007aff;
            background: #f9f9f9;
        }

        .tab-btn.active {
            color: #007aff;
            border-bottom-color: #007aff;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="top-bar">
            <h2>ğŸ¸ æŠ¢ç¥¨åŠ©æ‰‹</h2>
            <div>
                <span id="sys-clock" class="clock" style="font-size:16px;margin-right:10px;">--:--:--.---</span>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('semi-auto', this)">ğŸ–ï¸ åŠè‡ªåŠ¨æŠ¢ç¥¨</div>
            <div class="tab-btn" onclick="switchTab('auto-plan', this)">ğŸ¤– è‡ªåŠ¨æŠ¢ç¥¨è®¡åˆ’</div>
            <div class="tab-btn" onclick="switchTab('extend-plan', this)">ğŸ“… å»¶é•¿æŠ¢ç¥¨</div>
        </div>

        <!-- Tab 1: åŠè‡ªåŠ¨æŠ¢ç¥¨ (åŸä¸»é¡µå†…å®¹) -->
        <div id="tab-semi-auto" class="tab-content active">
            <div class="date-scroll">
                {% for d in dates %}
                <button class="date-btn {% if loop.index0 == 0 %}active{% endif %}"
                    onclick="selectDate('{{ d.val }}', this)">
                    <div style="font-size:12px;color:#666;">{{ d.weekday }}</div>
                    <div style="font-size:16px;font-weight:bold;">{{ d.date_only }}</div>
                </button>
                {% endfor %}
            </div>

            <div id="matrix-area">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- Tab 2: è‡ªåŠ¨æŠ¢ç¥¨è®¡åˆ’ (åŸé…ç½®åŒºåŸŸ) -->
        <div id="tab-auto-plan" class="tab-content">
            <div class="task-form">
                <div
                    style="background:#e3f2fd;color:#0056b3;padding:10px;border-radius:6px;font-size:13px;margin-bottom:15px;">
                    <b>ğŸ’¡ æç¤ºï¼š</b> åªè¦è®¾ç½®å¥½ï¼Œç³»ç»Ÿå°±ä¼šæŒ‰æ—¶å¸®æ‚¨æŠ¢ã€‚ä¸éœ€è¦ç®¡ç°åœ¨æœ‰æ²¡æœ‰ç©ºåœºã€‚
                </div>

                <!-- ç¬¬ä¸€è¡Œï¼šæ—¶é—´å’Œé¢‘ç‡ -->
                <div style="display:flex;gap:10px;">
                    <div class="form-group" style="flex:1">
                        <label>â° è§¦å‘æ—¶é—´</label>
                        <input type="time" id="taskTime" class="form-control" step="1" value="08:00:00"
                            onchange="updateTaskSummary()">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>ğŸ” é¢‘ç‡</label>
                        <select id="taskType" class="form-control" onchange="updateTaskSummary()">
                            <option value="daily">æ¯å¤©éƒ½æŠ¢</option>
                            <option value="weekly">æ¯å‘¨ä¸€æ¬¡</option>
                        </select>
                    </div>
                </div>

                <!-- é€Ÿåº¦è®¾ç½® -->
                <div class="form-group"
                    style="margin-top:10px;border:1px solid #eee;padding:10px;border-radius:8px;background:white;">
                    <label style="font-weight:bold;margin-bottom:8px;">âš¡ æŠ¢ç¥¨é€Ÿåº¦è®¾ç½® (æ¯«ç§’)</label>
                    <div style="display:flex;gap:10px;">
                        <div style="flex:1">
                            <label style="font-size:12px;">æ™®é€šé‡è¯•é—´éš”</label>
                            <input type="number" id="retryInterval" class="form-control" value="0.5" step="0.1"
                                min="0.1">
                        </div>
                        <div style="flex:1">
                            <label style="font-size:12px;color:#ff3b30;">ğŸ”¥ æ­»ç£•æ¨¡å¼é—´éš”</label>
                            <input type="number" id="aggressiveRetryInterval" class="form-control" value="0.3"
                                step="0.1" min="0.1">
                        </div>
                    </div>
                    <div style="font-size:12px;color:#999;margin-top:5px;">
                        * æ­»ç£•æ¨¡å¼ï¼šå½“æ£€æµ‹åˆ°æœåŠ¡å™¨å´©æºƒ/404æ—¶å¯ç”¨çš„æé€Ÿé‡è¯•é¢‘ç‡ã€‚<br>
                        * å»ºè®®å€¼ï¼šæ™®é€š 0.5sï¼Œæ­»ç£• 0.3sã€‚å¤ªå¿«å¯èƒ½ä¼šè¢«å°IPã€‚
                    </div>
                </div>

                <!-- é€šçŸ¥æ‰‹æœºå· -->
                <div class="form-group">
                    <label>ğŸ“± é€šçŸ¥æ‰‹æœºå· (å¤šä¸ªç”¨é€—å·åˆ†éš”)</label>
                    <div style="display:flex;gap:10px;">
                        <input type="text" id="notificationPhones" class="form-control"
                            placeholder="ä¾‹å¦‚: 13800000000, 13900000000">
                        <button class="btn" style="padding:6px 12px;font-size:12px;background:#eee;"
                            onclick="testSMS()">ğŸ“¡ æµ‹è¯•</button>
                        <button class="btn btn-success" style="padding:6px 12px;font-size:12px;"
                            onclick="saveConfig()">ğŸ’¾ ç¡®å®šä¿å­˜</button>
                    </div>
                </div>

                <!-- Token æ£€æŸ¥ä¸æ›´æ–° -->
                <div class="form-group"
                    style="margin-top:5px;border:1px solid #eee;padding:10px;border-radius:8px;background:white;">
                    <label style="margin-bottom:8px;font-weight:bold;">ğŸ”‘ å‡­è¯ç®¡ç†</label>

                    <button class="btn"
                        style="width:100%;padding:8px;font-size:13px;background:#f0f0f5;color:#333;border:1px solid #ddd;margin-bottom:10px;"
                        onclick="checkToken()">ğŸ” æ£€æŸ¥å½“å‰ Token æœ‰æ•ˆæ€§</button>

                    <div id="authUpdateArea" style="display:none;">
                        <textarea id="newToken" class="form-control" placeholder="ç²˜è´´æ–°çš„ token (oy9...)" rows="1"
                            style="margin-bottom:5px;font-size:12px;"></textarea>
                        <textarea id="newCookie" class="form-control" placeholder="ç²˜è´´æ–°çš„ cookie (JSESSIONID=...)"
                            rows="2" style="margin-bottom:5px;font-size:12px;"></textarea>
                        <button class="btn btn-success" style="width:100%;padding:6px;font-size:13px;"
                            onclick="updateAuth()">ğŸ’¾ ä¿å­˜å¹¶æ›´æ–°</button>
                    </div>

                    <div style="text-align:center;">
                        <a href="javascript:void(0)"
                            onclick="document.getElementById('authUpdateArea').style.display='block';this.style.display='none'"
                            style="font-size:12px;color:#007aff;text-decoration:none;">âœï¸ æˆ‘è¦æ›´æ–° Token</a>
                    </div>
                    <button class="btn"
                        style="width:100%;padding:8px;font-size:13px;background:#f0f0f5;color:#333;border:1px solid #ddd;margin-top:10px;"
                        onclick="refreshCookie()">ğŸ”„ åˆ·æ–° Cookie</button>
                </div>

                <!-- æ—¥æœŸé€‰æ‹© -->
                <div class="form-group">
                    <label>ğŸ“… æŠ¢å“ªå¤©çš„åœºï¼Ÿ</label>
                    <div id="targetDateList"
                        style="display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;margin-top:5px;">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <input type="hidden" id="taskOffset" value="2">
                </div>

                <!-- åœºåœ°é€‰æ‹©åŒºåŸŸ -->
                <div class="form-group" style="border:1px solid #eee;padding:10px;border-radius:8px;background:white;">
                    <label style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
                        <span>ğŸ¸ åœºåœ°é€‰æ‹©æ¨¡å¼</span>
                        <select id="placeMode" style="padding:4px;font-size:12px;" onchange="togglePlaceMode()">
                            <option value="normal">ğŸ¯ æ™®é€šå¤šé€‰</option>
                            <option value="priority">ğŸ”¥ åœºåœ°ä¼˜å…ˆ</option>
                            <option value="time_priority">â° æ—¶é—´ä¼˜å…ˆ</option>
                        </select>
                    </label>

                    <!-- æ¨¡å¼A: æ™®é€šé€‰åœº -->
                    <div id="modeNormal">
                        <div class="tag-selector" id="placeSelector">
                            <!-- JS ç”Ÿæˆ 1-15å· -->
                        </div>
                        <div style="margin-top:10px;padding-top:10px;border-top:1px dashed #eee;">
                            <label style="font-size:12px;color:#666;">
                                <input type="checkbox" id="taskSmartMode" checked>
                                <b>æ™ºèƒ½è¿å·ä¼˜å…ˆ</b> (è‡ªåŠ¨æ‰¾ 6+7, 8+9...)
                            </label>
                        </div>
                    </div>

                    <!-- æ¨¡å¼C: æ—¶é—´ä¼˜å…ˆ -->
                    <div id="modeTimePriority" style="display:none;">


                    </div>
                    <div class="tag-selector" id="placeSelectorTime">
                        <!-- JS ç”Ÿæˆ 1-15å· -->
                    </div>
                </div>

                <!-- æ¨¡å¼B: ä¼˜å…ˆçº§åºåˆ— -->
                <div id="modePriority" style="display:none;">
                    <input type="text" id="priorityInput" class="form-control" placeholder="ä¾‹å¦‚: 6-7, 8-9, 5-6"
                        style="font-family:monospace;">
                    <div style="font-size:12px;color:#999;margin-top:5px;">
                        * è¯·æŒ‰ä¼˜å…ˆçº§è¾“å…¥è¿å·ç»„åˆï¼Œç”¨é€—å·åˆ†éš”ã€‚<br>
                        * ç³»ç»Ÿä¼šä¾æ¬¡å°è¯•ï¼Œç›´åˆ°æŠ¢å¤Ÿæ•°é‡ã€‚
                    </div>
                    <div style="margin-top:10px;padding-top:10px;border-top:1px dashed #eee;">
                        <label style="font-size:12px;color:#666;">
                            <input type="checkbox" id="taskAllowPartial" checked>
                            <b>å…è®¸æ‹†åˆ†åºåˆ—</b> (å¦‚æœå®Œæ•´ç»„åˆä¸å¤Ÿï¼Œè‡ªåŠ¨å‡‘å•)
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ¯ æ€»ç›®æ ‡æ•°é‡ (å³éœ€è¦æŠ¢åˆ°çš„æ€»å°æ—¶æ•°)</label>
                <select id="taskTargetCount" class="form-control">
                    <option value="1">1</option>
                    <option value="2" selected>2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="8">8</option>
                    <option value="10">10</option>
                </select>
            </div>

            <!-- æ—¶é—´é€‰æ‹©å™¨ -->
            <div class="form-group">
                <label id="timeLabelNormal">âŒš é€‰æ‹©æ—¶é—´æ®µ (å¯å¤šé€‰ï¼Œç³»ç»Ÿä¼šå°è¯•å‡‘å¤Ÿæ€»ç›®æ ‡æ•°é‡)</label>
                <label id="timeLabelPriority" style="display:none">âŒš è¾“å…¥ä¼˜å…ˆæ—¶é—´æ®µ (ä¾‹å¦‚ 13-15)</label>

                <div class="tag-selector" id="timeSelector">
                    <!-- JS ç”Ÿæˆ 10:00-22:00 -->
                </div>

                <div id="timeRangeArea" style="display:none">
                    <input type="text" id="timeRangeInput" class="form-control" placeholder="ä¾‹å¦‚: 13-15, 18-20"
                        style="font-family:monospace;">
                    <div style="font-size:12px;color:#999;margin-top:5px;">
                        * æ ¼å¼è¯´æ˜ï¼šè¾“å…¥ "13-15" ä»£è¡¨é¢„å®š 13:00 åˆ° 15:00 æœŸé—´çš„åœºæ¬¡ï¼ˆå³13:00å’Œ14:00ï¼‰ã€‚<br>
                        * å¤šä¸ªæ—¶é—´æ®µç”¨é€—å·åˆ†éš”ã€‚
                    </div>
                </div>
            </div>

            <div style="margin-top:15px;padding-top:10px;border-top:1px dashed #ddd;font-size:13px;color:#007aff;font-weight:bold;margin-bottom:10px;"
                id="taskSummary">
                è¯·é…ç½®ä»»åŠ¡...
            </div>

            <button class="btn btn-primary" style="width:100%" onclick="createTask()">âœ… ä¿å­˜è®¡åˆ’</button>
        </div>

        <div class="task-list" id="taskList">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- Tab 3: å»¶é•¿æŠ¢ç¥¨ (è‡ªå®šä¹‰å¤©æ•°) -->
    <div id="tab-extend-plan" class="tab-content">
        <div class="task-form">
            <div
                style="background:#fff3cd;color:#856404;padding:10px;border-radius:6px;font-size:13px;margin-bottom:15px;">
                <b>ğŸ“… å»¶é•¿æ¨¡å¼ï¼š</b> é€‚ç”¨äºæ›´è¿œæœŸçš„é¢„å®šã€‚æ‚¨å¯ä»¥æŒ‡å®šä»ä»Šå¤©å¼€å§‹å»¶é•¿å¤šå°‘å¤©åæ‰§è¡Œä»»åŠ¡ã€‚
            </div>

            <!-- å»¶é•¿å¤©æ•°é…ç½® -->
            <div class="form-group">
                <label>ğŸ“† å»¶é•¿å¤©æ•° (ä»ä»Šå¤©å¼€å§‹)</label>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span>ä»Šå¤© + </span>
                    <input type="number" id="extendDays" class="form-control" style="width:80px;text-align:center"
                        value="7" min="1">
                    <span>å¤© = </span>
                    <span id="extendDatePreview" style="font-weight:bold;color:#007aff">--/--</span>
                </div>
            </div>

            <!-- æ—¶é—´å’Œé¢‘ç‡ -->
            <div style="display:flex;gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>â° è§¦å‘æ—¶é—´</label>
                    <input type="time" id="extendTaskTime" class="form-control" step="1" value="08:00:00">
                </div>
                <div class="form-group" style="flex:1">
                    <label>ğŸ” é¢‘ç‡</label>
                    <select id="extendTaskType" class="form-control">
                        <option value="daily">æ¯å¤©éƒ½æŠ¢</option>
                        <option value="weekly">æ¯å‘¨ä¸€æ¬¡</option>
                    </select>
                </div>
            </div>

            <!-- åœºåœ°å’Œæ—¶é—´é€‰æ‹© (å¤ç”¨é€»è¾‘) -->
            <div class="form-group">
                <label>âŒš é€‰æ‹©æ—¶é—´æ®µ (å¯å¤šé€‰)</label>
                <div class="tag-selector" id="extendTimeSelector">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ¸ é€‰æ‹©åœºåœ° (æ™®é€šæ¨¡å¼)</label>
                <div class="tag-selector" id="extendPlaceSelector">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ¯ ç›®æ ‡æ•°é‡</label>
                <select id="extendTargetCount" class="form-control">
                    <option value="1">1å—</option>
                    <option value="2" selected>2å—</option>
                    <option value="3">3å—</option>
                </select>
            </div>

            <button class="btn btn-primary" style="width:100%;margin-top:15px;" onclick="createExtendTask()">âœ…
                ä¿å­˜å»¶é•¿è®¡åˆ’</button>
        </div>
    </div>
    </div>

    <!-- åº•éƒ¨æ  (åªåœ¨åŠè‡ªåŠ¨é¡µé¢æ˜¾ç¤º) -->
    <div class="bottom-bar" id="bottomBar">
        <div class="bar-content">
            <div class="selected-tags" id="tagList"></div>
            <div class="status-row">
                <div class="info">å·²é€‰: <span id="count" style="color:#007aff">0</span> ä¸ªåœºåœ°</div>
                <div class="clock" id="countdown"></div>
            </div>
            <div class="control-row">
                <div class="timer-box">
                    <label><input type="checkbox" id="timerEnable" onchange="toggleTimer()"> å®šæ—¶æŠ¢ç¥¨</label>
                    <input type="datetime-local" id="timerInput" class="form-control"
                        style="width:200px;font-size:13px;padding:2px;" disabled>
                </div>
                <button class="btn btn-primary" id="btnNow" onclick="submitOrder(false)" disabled>ç«‹å³ä¸‹å•</button>
                <button class="btn btn-success" id="btnTimer" onclick="startTimer()"
                    style="display:none;">å¯åŠ¨å€’è®¡æ—¶</button>
                <button class="btn btn-danger" id="btnStop" onclick="stopTimer()" style="display:none;">åœæ­¢</button>
            </div>
        </div>
    </div>

    <!-- æ—¥å¿—è¾“å‡ºçª—å£ -->
    <div id="logConsole" style="
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 150px;
        background: #1e1e1e;
        color: #00ff00;
        font-family: monospace;
        font-size: 12px;
        padding: 10px;
        overflow-y: auto;
        z-index: 200;
        display: none;
        border-top: 2px solid #333;
    ">
        <div
            style="position:sticky;top:0;background:#1e1e1e;border-bottom:1px solid #333;margin-bottom:5px;display:flex;justify-content:space-between;">
            <span>ğŸ“Ÿ è¿è¡Œæ—¥å¿—</span>
            <span style="cursor:pointer;color:#fff;" onclick="toggleLogConsole()">â–¼ éšè—</span>
        </div>
        <div id="logContent"></div>
    </div>

    <!-- æ‚¬æµ®æ—¥å¿—æŒ‰é’® -->
    <div id="logToggleBtn" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        cursor: pointer;
        z-index: 201;
        font-size: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    " onclick="toggleLogConsole()">
        ğŸ“Ÿ æ˜¾ç¤ºæ—¥å¿—
    </div>

    <script>
        let currentDate = '{{ dates[0].val }}';
        let selectedItems = new Set();
        let timerInterval = null;
        let isTimerRunning = false;
        let serverOffset = 0;
        let cachedPlaces = []; // å­˜å‚¨åç«¯è¿”å›çš„åœºåœ°åˆ—è¡¨
        let lastLogIndex = 0; // è®°å½•æ—¥å¿—ä½ç½®

        function toggleLogConsole() {
            const console = document.getElementById('logConsole');
            const btn = document.getElementById('logToggleBtn');
            if (console.style.display === 'none') {
                console.style.display = 'block';
                btn.style.display = 'none';
                // è°ƒæ•´åº•éƒ¨æ ä½ç½®é˜²æ­¢é®æŒ¡ (å¦‚æœæœ‰çš„è¯)
                document.getElementById('bottomBar').style.bottom = '170px';
            } else {
                console.style.display = 'none';
                btn.style.display = 'block';
                document.getElementById('bottomBar').style.bottom = '0';
            }
        }

        async function pollLogs() {
            try {
                const res = await fetch('/api/logs');
                const logs = await res.json();
                if (logs.length > lastLogIndex) {
                    const newLogs = logs.slice(lastLogIndex);
                    const content = document.getElementById('logContent');
                    newLogs.forEach(line => {
                        const div = document.createElement('div');
                        div.innerText = line;
                        content.appendChild(div);
                    });
                    lastLogIndex = logs.length;
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    document.getElementById('logConsole').scrollTop = document.getElementById('logConsole').scrollHeight;
                }
            } catch (e) { }
        }

        function switchTab(tabId, btn) {
            // åˆ‡æ¢ Tab å†…å®¹
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // åˆ‡æ¢æŒ‰é’®æ ·å¼
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');

            // åº•éƒ¨æ åªåœ¨åŠè‡ªåŠ¨æ¨¡å¼æ˜¾ç¤º
            const bar = document.getElementById('bottomBar');
            if (tabId === 'semi-auto') {
                bar.style.display = 'block';
            } else {
                bar.style.display = 'none';
            }

            // å¦‚æœæ˜¯å»¶é•¿æŠ¢ç¥¨ï¼Œåˆå§‹åŒ–å…¶ä¸­çš„é€‰æ‹©å™¨
            if (tabId === 'extend-plan') {
                initExtendSelectors();
                updateExtendDatePreview();
            }
        }

        function initExtendSelectors() {
            // æ—¶é—´é€‰æ‹©å™¨
            const timeContainer = document.getElementById('extendTimeSelector');
            if (timeContainer.children.length === 0) {
                for (let i = 8; i <= 22; i++) {
                    const timeStr = String(i).padStart(2, '0') + ":00";
                    const btn = document.createElement('div');
                    btn.className = 'tag-btn';
                    btn.innerText = timeStr;
                    btn.onclick = () => {
                        // é™åˆ¶æ ¡éªŒ
                        if (!btn.classList.contains('active')) {
                            const count = document.querySelectorAll('#extendTimeSelector .active').length;
                            if (count >= 3) return alert("âš ï¸ é™åˆ¶ï¼šæœ€å¤šåªèƒ½é€‰ 3 ä¸ªæ—¶é—´æ®µï¼");
                        }
                        btn.classList.toggle('active');
                    };
                    timeContainer.appendChild(btn);
                }
            }

            // åœºåœ°é€‰æ‹©å™¨
            const placeContainer = document.getElementById('extendPlaceSelector');
            if (placeContainer.children.length === 0) {
                const placesToRender = (cachedPlaces && cachedPlaces.length > 0) ? cachedPlaces : Array.from({ length: 15 }, (_, i) => String(i + 1));
                placesToRender.forEach(p => {
                    const btn = document.createElement('div');
                    btn.className = 'tag-btn';
                    btn.innerText = p + "å·";
                    btn.onclick = () => {
                        // é™åˆ¶æ ¡éªŒ
                        if (!btn.classList.contains('active')) {
                            const count = document.querySelectorAll('#extendPlaceSelector .active').length;
                            if (count >= 3) return alert("âš ï¸ é™åˆ¶ï¼šæœ€å¤šåªèƒ½é€‰ 3 ä¸ªåœºåœ°ï¼");
                        }
                        btn.classList.toggle('active');
                    };
                    placeContainer.appendChild(btn);
                });
            }

            // ç›‘å¬å¤©æ•°è¾“å…¥å˜åŒ–
            document.getElementById('extendDays').oninput = updateExtendDatePreview;
        }

        function updateExtendDatePreview() {
            const days = parseInt(document.getElementById('extendDays').value) || 0;
            const d = new Date();
            d.setDate(d.getDate() + days);
            const str = `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
            document.getElementById('extendDatePreview').innerText = str;
        }

        async function createExtendTask() {
            const offset = parseInt(document.getElementById('extendDays').value);
            if (!offset || offset < 1) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å¤©æ•°");

            const time = document.getElementById('extendTaskTime').value;
            const type = document.getElementById('extendTaskType').value;
            const targetCount = document.getElementById('extendTargetCount').value;

            // è·å–é€‰ä¸­çš„æ—¶é—´å’Œåœºåœ°
            const selectedTimes = Array.from(document.querySelectorAll('#extendTimeSelector .active')).map(el => el.innerText);
            const selectedPlaces = Array.from(document.querySelectorAll('#extendPlaceSelector .active')).map(el => el.innerText.replace('å·', ''));

            if (selectedTimes.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¶é—´æ®µ');
            if (selectedPlaces.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåœºåœ°');

            // æ„é€ é…ç½® (å¤ç”¨ Normal æ¨¡å¼ç»“æ„)
            const config = {
                mode: 'normal',
                candidate_places: selectedPlaces,
                target_times: selectedTimes,
                target_count: parseInt(targetCount),
                smart_continuous: true // é»˜è®¤å¼€å¯æ™ºèƒ½è¿å·
            };

            const task = {
                run_time: time,
                type: type,
                target_day_offset: offset,
                config: config,
                weekly_day: type === 'weekly' ? new Date().getDay() : 0 // ç®€å•å¤„ç†ï¼Œé»˜è®¤ä¸ºä»Šå¤©å‘¨å‡ 
            };

            try {
                await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(task)
                });
                alert('å»¶é•¿è®¡åˆ’å·²æ·»åŠ ï¼');
                // åˆ‡æ¢å›è‡ªåŠ¨è®¡åˆ’ Tab æŸ¥çœ‹åˆ—è¡¨
                switchTab('auto-plan', document.querySelectorAll('.tab-btn')[1]);
                loadTasks();
            } catch (e) { alert('æ·»åŠ å¤±è´¥'); }
        }

        // åˆå§‹åŒ–
        loadMatrix(currentDate);
        syncTime();
        setInterval(updateClock, 30);
        setInterval(pollLogs, 1000); // æ¯ç§’è½®è¯¢æ—¥å¿—

        // åˆå§‹åŒ–ä»»åŠ¡åŒºåŸŸ (é¡µé¢åŠ è½½æ—¶ç›´æ¥è°ƒç”¨)
        initDateSelector();
        // initPlaceSelector ç§»åˆ° renderTable ä¹‹åè°ƒç”¨ï¼Œæˆ–è€…ç»™ä¸ªé»˜è®¤è°ƒç”¨
        initPlaceSelector();
        initTimeSelector();
        loadTasks();
        loadConfig();
        updateTaskSummary();

        // ... (ä¹‹å‰çš„ syncTime, updateClock, selectDate, loadMatrix, renderTable, toggleCell ä¿æŒä¸å˜) ...
        // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå¤ç”¨ä¹‹å‰çš„é€»è¾‘ï¼Œåªå¢åŠ æ–°åŠŸèƒ½çš„JS

        async function syncTime() {
            const start = Date.now();
            try {
                const res = await fetch('/api/time');
                const data = await res.json();
                const end = Date.now();
                const serverTime = data.timestamp * 1000;
                serverOffset = serverTime - end + (end - start) / 2;
            } catch (e) { }
        }

        function updateClock() {
            const now = new Date(Date.now() + serverOffset);
            const timeStr = now.toLocaleTimeString('en-GB') + '.' + String(now.getMilliseconds()).padStart(3, '0');
            document.getElementById('sys-clock').innerText = timeStr;

            if (isTimerRunning) {
                const targetVal = document.getElementById('timerInput').value; // "2026-01-09T08:00"
                if (!targetVal) return;

                const targetTime = new Date(targetVal).getTime();
                const currentTime = now.getTime();

                // å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
                const diff = (targetTime - currentTime) / 1000;

                if (diff <= 0) {
                    stopTimer();
                    submitOrder(true);
                } else {
                    let info = "";
                    if (diff > 3600) info = `> ${Math.floor(diff / 3600)}å°æ—¶`;
                    else if (diff > 60) info = `${Math.floor(diff / 60)}åˆ†${Math.floor(diff % 60)}ç§’`;
                    else info = diff.toFixed(1) + "ç§’";

                    document.getElementById('countdown').innerText = `â³ å€’è®¡æ—¶: ${info}`;
                    document.getElementById('countdown').style.color = "#ff9500";
                }
            } else {
                document.getElementById('countdown').innerText = "";
            }
        }

        function selectDate(date, btn) {
            currentDate = date;
            document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadMatrix(date);
            selectedItems.clear();
            updateBar();
        }

        async function loadMatrix(date) {
            const area = document.getElementById('matrix-area');
            area.innerHTML = '<div class="loading">æ­£åœ¨è·å–åœºåœ°çŠ¶æ€...</div>';
            try {
                const res = await fetch(`/api/matrix?date=${date}`);
                const data = await res.json();
                if (data.error) { area.innerHTML = `<div style="color:red;text-align:center">${data.error}</div>`; return; }
                renderTable(data);
            } catch (e) { area.innerHTML = `<div style="color:red;text-align:center">ç½‘ç»œé”™è¯¯</div>`; }
        }

        function renderTable(data) {
            const { places, times, matrix } = data;
            cachedPlaces = places; // æ›´æ–°ç¼“å­˜

            // è®¡ç®—æ—¥æœŸåç§»é‡
            let forceAvailable = false;
            try {
                const parts = currentDate.split('-');
                const target = new Date(parts[0], parts[1] - 1, parts[2]);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffTime = target - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                // ç”¨æˆ·éœ€æ±‚ï¼š7å¤©ä¹‹åï¼ˆåŒ…æ‹¬ä»Šå¤©ï¼‰-> ç†è§£ä¸ºä»ç¬¬7å¤©å¼€å§‹ (Offset >= 6)
                if (diffDays >= 6) {
                    forceAvailable = true;
                }
            } catch (e) { console.error(e); }

            // æ ¸å¿ƒä¿®å¤é€»è¾‘ï¼šä¼˜å…ˆæ˜¾ç¤ºçœŸå®æ•°æ®
            // åªæœ‰å½“æ²¡æœ‰çœŸå®æ•°æ®ï¼Œä¸”å¤„äºè¿œæœŸæ¨¡å¼æ—¶ï¼Œæ‰å¯ç”¨å‡æ•°æ®ï¼ˆæ„¿æœ›å•æ¨¡å¼ï¼‰
            const hasRealData = data && data.matrix && Object.keys(data.matrix).length > 0;
            let isFakeMode = false;

            if (!hasRealData && forceAvailable) {
                isFakeMode = true;
                // å¦‚æœæ˜¯å‡æ¨¡å¼ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä»½å…¨ç»¿çš„æ•°æ®ç»“æ„
                // æ³¨æ„ï¼šå¦‚æœ data.places ä¸ºç©ºï¼Œæˆ‘ä»¬ä¹Ÿå¾—é€ ä¸€ä»½
                if (!data.places || data.places.length === 0) {
                    data.places = Array.from({ length: 15 }, (_, i) => String(i + 1));
                    data.times = Array.from({ length: 15 }, (_, i) => String(i + 8).padStart(2, '0') + ":00");
                    data.matrix = {};
                }
                data.places.forEach(p => {
                    data.matrix[p] = {};
                    data.times.forEach(t => data.matrix[p][t] = 'available');
                });
                // é‡æ–°èµ‹å€¼ç»™å±€éƒ¨å˜é‡
                places.length = 0; places.push(...data.places);
                times.length = 0; times.push(...data.times);
                // matrix å¼•ç”¨å·²æ›´æ–°
            }

            // å†æ¬¡æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
            if (!data.matrix || Object.keys(data.matrix).length === 0) {
                document.getElementById('matrix-area').innerHTML = '<div style="text-align:center;padding:20px;color:#999">æš‚æ— æ•°æ® (æœªå¼€æ”¾)</div>';
                return;
            }

            // çŠ¶æ€æç¤ºæ¡
            let statusHtml = '';
            if (isFakeMode) {
                statusHtml = '<div style="background:#fff3cd;color:#856404;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:10px;border:1px solid #ffeeba;">âš ï¸ <b>æ„¿æœ›å•æ¨¡å¼</b>ï¼šç³»ç»Ÿæœªè·å–åˆ°è¯¥æ—¥æœŸçš„å®æ—¶æ•°æ®ï¼ˆå¯èƒ½æ˜¯å°šæœªå¼€æ”¾æˆ–ç½‘ç»œæ³¢åŠ¨ï¼‰ã€‚æ‚¨å¯ä»¥ç»§ç»­é€‰åº§ï¼Œç³»ç»Ÿä¼šåœ¨ä»»åŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨å°è¯•æŠ¢è¿™äº›ä½ç½®ã€‚</div>';
            } else {
                statusHtml = '<div style="background:#d4edda;color:#155724;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:10px;border:1px solid #c3e6cb;">âœ… <b>å®æ—¶æ•°æ®</b>ï¼šå½“å‰æ˜¾ç¤ºçš„æ˜¯æœ€æ–°çš„åœºåœ°çŠ¶æ€ã€‚</div>';
            }

            let html = statusHtml + '<table><thead><tr><th>æ—¶é—´ \\ åœºåœ°</th>';
            places.forEach(p => html += `<th>${p}å·</th>`);
            html += '</tr></thead><tbody>';
            times.forEach(t => {
                html += `<tr><td>${t}</td>`;
                places.forEach(p => {
                    const status = matrix[p][t] || 'booked';
                    const key = `${p}|${t}`;
                    const isSel = selectedItems.has(key) ? 'selected' : '';

                    // ä¿®æ­£é€»è¾‘ï¼šåªæœ‰åœ¨å‡æ¨¡å¼ä¸‹ï¼Œæˆ–è€…çœŸå®çŠ¶æ€æ˜¯ available æ—¶ï¼Œæ‰æ˜¾ç¤ºç»¿è‰²
                    if (status === 'available' || isFakeMode) {
                        html += `<td><div class="cell available ${isSel}" data-key="${key}" onclick="toggleCell(this, '${p}', '${t}')"></div></td>`;
                    } else {
                        html += `<td><div class="cell booked"></div></td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('matrix-area').innerHTML = `<div class="matrix-container">${html}</div>`;
        }

        function toggleCell(el, place, time) {
            const key = `${place}|${time}`;
            if (selectedItems.has(key)) {
                selectedItems.delete(key);
                el.classList.remove('selected');
            } else {
                // é™åˆ¶æ ¡éªŒ
                let timeCount = 0; selectedItems.forEach(k => { if (k.startsWith(place + '|')) timeCount++; });
                // if (timeCount >= 3) return alert(`âš ï¸ é™åˆ¶ï¼šå•ä¸ªåœºåœ°æœ€å¤š3å°æ—¶`);

                let placeCount = 0; selectedItems.forEach(k => { if (k.endsWith('|' + time)) placeCount++; });
                // if (placeCount >= 3) return alert(`âš ï¸ é™åˆ¶ï¼šåŒæ—¶æ®µæœ€å¤š3å—åœºåœ°`);

                // å…¨å±€é™åˆ¶ï¼šæ€»æ•°ä¸è¶…è¿‡ 3 å— (ä¸´æ—¶æ”¾å®½åˆ° 9 å—ä»¥æ”¯æŒ 3x3 çŸ©é˜µ?)
                // ç”¨æˆ·è¯´ "æœ€å¤šé€‰ 3x3"ï¼Œæ„æ€æ˜¯ 3ä¸ªåœºåœ° x 3ä¸ªæ—¶æ®µ = 9ä¸ªæ ¼å­ï¼Ÿ
                // æˆ–è€…æ˜¯ä¹‹å‰çš„è§„åˆ™ï¼šåŒåœºåœ°æœ€å¤š3å°æ—¶ï¼ŒåŒæ—¶æ®µæœ€å¤š3åœºåœ°ã€‚
                // å¦‚æœç”¨æˆ·æƒ³ä¸€æ¬¡æ€§é€‰å¾ˆå¤šç„¶åæ‰¹é‡ä¸‹å•ï¼Œæˆ‘ä»¬è¿™é‡Œæš‚æ—¶æ”¾å®½å‰ç«¯é™åˆ¶ï¼Œ
                // ä½†è¦æç¤ºç”¨æˆ·å¦‚æœè¶…è¿‡é™åˆ¶å¯èƒ½ä¼šè¢«ç³»ç»Ÿæ‹’ç»ã€‚
                // ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¿ç•™ä¹‹å‰çš„ 3x3 é€»è¾‘ï¼Œä½†å¦‚æœç”¨æˆ·è¯´â€œä¸è¡Œâ€ï¼Œå¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬ä¹‹å‰çš„é™åˆ¶å¡ä½äº†ä»–é€‰æ›´å¤šï¼Ÿ
                // æˆ–è€…æ˜¯â€œå¼ºåˆ¶å¯é€‰â€å¯¼è‡´çŠ¶æ€é”™ä¹±ï¼Ÿ

                // é‡æ–°å®¡è§†ç”¨æˆ·éœ€æ±‚ï¼š"æœ€å¤šé€‰ 3x3... è¿™æ ·ä¸‹å•æ‰æœ‰æ•ˆ"
                // è¿™æ„å‘³ç€å¿…é¡»éµå®ˆ 3x3 è§„åˆ™ã€‚

                if (timeCount >= 3) return alert(`âš ï¸ é™åˆ¶ï¼šå•ä¸ªåœºåœ°æœ€å¤šåªèƒ½è¿ç»­è®¢ 3 ä¸ªå°æ—¶ï¼`);
                if (placeCount >= 3) return alert(`âš ï¸ é™åˆ¶ï¼šåŒä¸€ä¸ªæ—¶é—´æ®µæœ€å¤šåªèƒ½è®¢ 3 å—åœºåœ°ï¼`);

                selectedItems.add(key);
                el.classList.add('selected');
            }
            updateBar();
        }

        function updateBar() {
            const count = selectedItems.size;
            document.getElementById('count').innerText = count;
            // ç§»é™¤ä¸å­˜åœ¨çš„å…ƒç´ è°ƒç”¨
            // document.getElementById('taskSelCount').innerText = count; 
            const hasItem = count > 0;

            const btnNow = document.getElementById('btnNow');
            const btnTimer = document.getElementById('btnTimer');

            if (btnNow) btnNow.disabled = !hasItem;

            // åªæœ‰å½“å®šæ—¶æŠ¢ç¥¨è¢«å‹¾é€‰æ—¶ï¼Œæ‰æ“ä½œ btnTimer
            if (document.getElementById('timerEnable').checked) {
                if (btnTimer) btnTimer.disabled = !hasItem;
            }

            const tagContainer = document.getElementById('tagList');
            if (!tagContainer) return;

            tagContainer.innerHTML = '';
            const sortedKeys = Array.from(selectedItems).sort((a, b) => {
                const [p1, t1] = a.split('|');
                const [p2, t2] = b.split('|');
                if (Number(p1) !== Number(p2)) return Number(p1) - Number(p2);
                return t1.localeCompare(t2);
            });
            sortedKeys.forEach(key => {
                const [place, time] = key.split('|');
                const [h, m] = time.split(':');
                const nextH = parseInt(h) + 1;
                const timeRange = `${time}-${String(nextH).padStart(2, '0')}:00`;

                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `<span>${place}å· ${timeRange}</span><span class="tag-close" onclick="removeTag('${key}')">Ã—</span>`;
                tagContainer.appendChild(tag);
            });
        }

        function removeTag(key) {
            if (selectedItems.has(key)) {
                selectedItems.delete(key);
                const targetCell = document.querySelector(`.cell[data-key="${key}"]`);
                if (targetCell) targetCell.classList.remove('selected');
                updateBar();
            }
        }

        function toggleTimer() {
            const enabled = document.getElementById('timerEnable').checked;
            const input = document.getElementById('timerInput');
            input.disabled = !enabled;

            // å¦‚æœå¯ç”¨ä¸”ä¸ºç©ºï¼Œé»˜è®¤è®¾ç½®ä¸ºæ˜å¤©æ—©8ç‚¹
            if (enabled && !input.value) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(8, 0, 0, 0);
                // datetime-local æ ¼å¼: YYYY-MM-DDTHH:mm
                const y = tomorrow.getFullYear();
                const m = String(tomorrow.getMonth() + 1).padStart(2, '0');
                const d = String(tomorrow.getDate()).padStart(2, '0');
                input.value = `${y}-${m}-${d}T08:00`;
            }

            document.getElementById('btnNow').style.display = enabled ? 'none' : 'block';
            document.getElementById('btnTimer').style.display = enabled ? 'block' : 'none';
            if (!enabled) stopTimer();
        }

        function startTimer() {
            if (selectedItems.size === 0) return alert("è¯·å…ˆé€‰æ‹©åœºåœ°ï¼");
            isTimerRunning = true;
            document.getElementById('btnTimer').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';
            document.getElementById('timerInput').disabled = true;
            document.getElementById('timerEnable').disabled = true;
            document.querySelectorAll('.cell').forEach(c => c.style.pointerEvents = 'none');
        }

        function stopTimer() {
            isTimerRunning = false;
            document.getElementById('btnTimer').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
            document.getElementById('timerInput').disabled = false;
            document.getElementById('timerEnable').disabled = false;
            document.getElementById('countdown').innerText = "";
            document.querySelectorAll('.cell').forEach(c => c.style.pointerEvents = 'auto');
        }

        async function submitOrder(isAuto) {
            if (selectedItems.size === 0) return;
            if (!isAuto && !confirm(`ç¡®è®¤è¦é¢„å®šè¿™ ${selectedItems.size} ä¸ªåœºåœ°å—ï¼Ÿ`)) return;

            const btn = isAuto ? null : document.getElementById('btnNow');
            if (btn) { btn.disabled = true; btn.innerText = "æäº¤ä¸­..."; }

            const toast = document.createElement('div');
            toast.style.cssText = [
                "position:fixed",
                "top:20px",
                "left:50%",
                "transform:translateX(-50%)",
                "background:rgba(0,0,0,0.8)",
                "color:white",
                "padding:15px 30px",
                "border-radius:30px",
                "z-index:9999"
            ].join(";");
            toast.innerText = isAuto ? "â° æ—¶é—´åˆ°ï¼æ­£åœ¨è‡ªåŠ¨æŠ¢ç¥¨..." : "ğŸš€ æ­£åœ¨æäº¤è®¢å•...";
            document.body.appendChild(toast);

            const items = Array.from(selectedItems).map(key => {
                const [place, time] = key.split('|');
                return { place, time };
            });

            try {
                // å…³é”®ä¿®æ”¹ï¼šæ— è®ºæ‰‹åŠ¨è¿˜æ˜¯è‡ªåŠ¨ï¼Œæ¯æ¬¡åªå‘ 1 ä¸ª /api/book è¯·æ±‚
                const resp = await fetch('/api/book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: currentDate, items })
                });

                const result = await resp.json();
                document.body.removeChild(toast);

                if (result.status === 'success' || result.status === 'partial') {
                    const msg = result.status === 'success'
                        ? 'ğŸ‰ æŠ¢ç¥¨æˆåŠŸå–µï¼'
                        : 'ğŸ‰ æŠ¢ç¥¨éƒ¨åˆ†æˆåŠŸå–µï¼';
                    alert(msg);
                    loadMatrix(currentDate);
                    selectedItems.clear();
                    updateBar();
                    if (isAuto) stopTimer();
                } else {
                    alert('âŒ å¤±è´¥: ' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                document.body.removeChild(toast);
                alert('ç½‘ç»œé”™è¯¯');
            } finally {
                if (btn) { btn.disabled = false; btn.innerText = "ç«‹å³ä¸‹å•"; }
            }
        }


        // === ä»»åŠ¡ç®¡ç† JS ===

        function openTaskManager() {
            document.getElementById('taskModal').style.display = 'flex';
            initDateSelector();
            initPlaceSelector();
            initTimeSelector();
            loadTasks();
            loadConfig(); // åŠ è½½é…ç½®
            updateTaskSummary();
        }

        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                if (config.notification_phones) {
                    document.getElementById('notificationPhones').value = config.notification_phones.join(',');
                }
                if (config.retry_interval) {
                    document.getElementById('retryInterval').value = config.retry_interval;
                }
                if (config.aggressive_retry_interval) {
                    document.getElementById('aggressiveRetryInterval').value = config.aggressive_retry_interval;
                }
            } catch (e) { console.error(e); }
        }

        async function checkToken() {
            try {
                const res = await fetch('/api/config/check-token', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    alert('âœ… ' + data.msg);
                } else {
                    alert('âŒ ' + data.msg + '\n\nå¦‚æœå·²é…ç½®æ‰‹æœºå·ï¼Œç³»ç»Ÿå°è¯•å‘é€äº†æŠ¥è­¦çŸ­ä¿¡ã€‚');
                }
            } catch (e) {
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            }
        }

        async function refreshCookie() {
            try {
                const res = await fetch('/api/config/refresh-cookie', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    alert('âœ… ' + data.msg);
                } else {
                    alert('âŒ åˆ·æ–°å¤±è´¥: ' + data.msg);
                }
            } catch (e) {
                alert('åˆ·æ–°å¤±è´¥');
            }
        }

        async function updateAuth() {
            const token = document.getElementById('newToken').value.trim();
            const cookie = document.getElementById('newCookie').value.trim();
            if (!token || !cookie) return alert("è¯·å¡«å†™å®Œæ•´çš„ Token å’Œ Cookie");

            try {
                const res = await fetch('/api/config/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, cookie })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert('âœ… ' + data.msg);
                    document.getElementById('authUpdateArea').style.display = 'none';
                    // é‡æ–°æ£€æŸ¥ä¸€ä¸‹
                    checkToken();
                } else {
                    alert('âŒ æ›´æ–°å¤±è´¥: ' + data.msg);
                }
            } catch (e) { alert('æ›´æ–°å¤±è´¥'); }
        }

        async function saveConfig() {
            const phones = document.getElementById('notificationPhones').value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            // if (phones.length === 0) return alert('è¯·è¾“å…¥æ‰‹æœºå·'); // å…è®¸ä¸è¾“æ‰‹æœºå·ä¿å­˜å…¶ä»–é…ç½®

            const retryInterval = parseFloat(document.getElementById('retryInterval').value) || 0.5;
            const aggressiveRetryInterval = parseFloat(document.getElementById('aggressiveRetryInterval').value) || 0.3;

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        notification_phones: phones,
                        retry_interval: retryInterval,
                        aggressive_retry_interval: aggressiveRetryInterval
                    })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert('âœ… é…ç½®å·²ä¿å­˜ï¼');
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + data.msg);
                }
            } catch (e) {
                console.error(e);
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function testSMS() {
            const phones = document.getElementById('notificationPhones').value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            if (phones.length === 0) return alert('è¯·å…ˆè¾“å…¥æ‰‹æœºå·');

            try {
                const res = await fetch('/api/config/test-sms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phones })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert('âœ… ' + data.msg);
                } else {
                    alert('âŒ ' + data.msg);
                }
            } catch (e) {
                console.error(e);
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
            }
        }

        function initDateSelector() {
            const container = document.getElementById('targetDateList');
            container.innerHTML = '';
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

            // ç”Ÿæˆæœªæ¥14å¤©
            for (let i = 0; i < 14; i++) {
                const d = new Date();
                d.setDate(d.getDate() + i);
                const dateStr = `${d.getMonth() + 1}/${d.getDate()}`;
                const weekStr = weekdays[d.getDay()];

                const btn = document.createElement('div');
                btn.style.cssText = "padding:6px;border:1px solid #ddd;border-radius:6px;cursor:pointer;text-align:center;font-size:12px;background:white;";
                btn.innerHTML = `<b>${dateStr}</b><br><span style="color:#666;font-size:11px">${weekStr}</span>`;
                if (i === 0) btn.innerHTML = `<b>ä»Šå¤©</b><br><span style="color:red;font-size:11px">${weekStr}</span>`;
                if (i === 1) btn.innerHTML = `<b>æ˜å¤©</b><br><span style="color:green;font-size:11px">${weekStr}</span>`;

                btn.onclick = () => {
                    document.querySelectorAll('#targetDateList div').forEach(b => {
                        b.style.borderColor = '#ddd';
                        b.style.background = 'white';
                        b.style.color = '#333';
                    });
                    btn.style.borderColor = '#007aff';
                    btn.style.background = '#e3f2fd';
                    btn.style.color = '#007aff';
                    document.getElementById('taskOffset').value = i;
                    updateTaskSummary();
                };

                // é»˜è®¤é€‰ä¸­åå¤© (i=2)
                if (i === 2) btn.click();

                container.appendChild(btn);
            }
        }

        function initPlaceSelector() {
            const container = document.getElementById('placeSelector');
            const containerTime = document.getElementById('placeSelectorTime'); // æ–°å¢
            container.innerHTML = '';
            containerTime.innerHTML = ''; // æ–°å¢

            // ä½¿ç”¨ç¼“å­˜çš„åœºåœ°åˆ—è¡¨ï¼Œå¦‚æœä¸ºç©ºåˆ™å…œåº•æ˜¾ç¤º 1-15
            const placesToRender = (cachedPlaces && cachedPlaces.length > 0) ? cachedPlaces : Array.from({ length: 15 }, (_, i) => String(i + 1));

            placesToRender.forEach(p => {
                // æ™®é€šæ¨¡å¼é€‰æ‹©å™¨
                const btn = document.createElement('div');
                btn.className = 'tag-btn';
                btn.innerText = p + "å·";
                btn.onclick = () => {
                    // æ¢å¤é™åˆ¶ï¼šå¦‚æœå½“å‰æœªé€‰ä¸­ï¼Œä¸”å·²é€‰æ•°é‡ >= 3ï¼Œåˆ™ç¦æ­¢é€‰ä¸­
                    if (!btn.classList.contains('active')) {
                        const count = document.querySelectorAll('#placeSelector .active').length;
                        if (count >= 3) return alert("âš ï¸ é™åˆ¶ï¼šåŒä¸€æ—¶é—´æ®µæœ€å¤šåªèƒ½æŠ¢ 3 ä¸ªåœºåœ°ï¼");
                    }
                    btn.classList.toggle('active');
                    updateTaskSummary();
                };
                container.appendChild(btn);

                // æ—¶é—´ä¼˜å…ˆæ¨¡å¼é€‰æ‹©å™¨ (é€»è¾‘ä¸€æ ·ï¼Œåªæ˜¯å®¹å™¨ä¸åŒ)
                const btn2 = btn.cloneNode(true);
                btn2.onclick = () => {
                    if (!btn2.classList.contains('active')) {
                        const count = document.querySelectorAll('#placeSelectorTime .active').length;
                        if (count >= 3) return alert("âš ï¸ é™åˆ¶ï¼šæœ€å¤šåªèƒ½é€‰ 3 ä¸ªå€™é€‰åœºåœ°ï¼");
                    }
                    btn2.classList.toggle('active');
                    updateTaskSummary();
                };
                containerTime.appendChild(btn2);
            });
        }

        function initTimeSelector() {
            const container = document.getElementById('timeSelector');
            if (container.children.length > 0) return;
            for (let i = 8; i <= 22; i++) {
                const timeStr = String(i).padStart(2, '0') + ":00";
                const btn = document.createElement('div');
                btn.className = 'tag-btn';
                btn.innerText = timeStr;
                btn.onclick = () => {
                    // æ¢å¤é™åˆ¶ï¼šå¦‚æœå½“å‰æœªé€‰ä¸­ï¼Œä¸”å·²é€‰æ•°é‡ >= 3ï¼Œåˆ™ç¦æ­¢é€‰ä¸­
                    if (!btn.classList.contains('active')) {
                        const count = document.querySelectorAll('#timeSelector .active').length;
                        if (count >= 3) return alert("âš ï¸ é™åˆ¶ï¼šå•ä¸ªåœºåœ°æœ€å¤šåªèƒ½æŠ¢ 3 ä¸ªå°æ—¶ï¼");
                    }
                    btn.classList.toggle('active');
                    updateTaskSummary();
                };
                container.appendChild(btn);
            }
        }

        function updateTaskSummary() {
            const offset = parseInt(document.getElementById('taskOffset').value);
            const type = document.getElementById('taskType').value;
            const time = document.getElementById('taskTime').value;
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

            const today = new Date();
            const targetDate = new Date();
            targetDate.setDate(today.getDate() + offset);
            const targetWeek = weekdays[targetDate.getDay()];

            // ç»Ÿè®¡å·²é€‰åœºåœ°å’Œæ—¶é—´
            const pCount = document.querySelectorAll('#placeSelector .active').length;
            const tCount = document.querySelectorAll('#timeSelector .active').length;

            let text = "";
            if (type === 'daily') {
                text = `æ¯å¤© ${time} å¯åŠ¨ï¼ŒæŠ¢ ${targetWeek} çš„åœº`;
            } else {
                const currentWeek = weekdays[today.getDay()];
                text = `æ¯å‘¨${currentWeek} ${time} å¯åŠ¨ï¼ŒæŠ¢ ${targetWeek} çš„åœº`;
            }

            text += `<br><span style="color:#333;font-weight:normal">å·²é€‰ ${pCount} ä¸ªåœºåœ° Ã— ${tCount} ä¸ªæ—¶æ®µ = å…± ${pCount * tCount} ä¸ªç›®æ ‡</span>`;

            document.getElementById('taskSummary').innerHTML = text;
        }

        function closeTaskManager() {
            document.getElementById('taskModal').style.display = 'none';
        }

        async function loadTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = 'åŠ è½½ä¸­...';
            try {
                const res = await fetch('/api/tasks');
                const tasks = await res.json();
                list.innerHTML = '';
                if (tasks.length === 0) {
                    list.innerHTML = '<div style="text-align:center;color:#999">æš‚æ— ä»»åŠ¡</div>';
                    return;
                }
                tasks.forEach(t => {
                    let desc = "";
                    if (t.type === 'daily') desc = `æ¯å¤© ${t.run_time}`;
                    else desc = `æ¯å‘¨${['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'][t.weekly_day]} ${t.run_time}`;

                    let dayDesc = "";
                    if (t.target_day_offset === 0) dayDesc = "å½“å¤©";
                    else if (t.target_day_offset === 1) dayDesc = "æ˜å¤©";
                    else if (t.target_day_offset === 2) dayDesc = "åå¤©";
                    else dayDesc = `${t.target_day_offset}å¤©å`;

                    // æ™ºèƒ½ç­–ç•¥æè¿°
                    let detail = "";
                    if (t.config) {
                        if (t.config.mode === 'priority') {
                            // ä¼˜å…ˆçº§æ¨¡å¼
                            const seqStr = t.config.priority_sequences.map(s => `[${s.join('+')}]`).join(', ');
                            const tStr = t.config.target_times.join(',');
                            detail = `ğŸ¯ ç›®æ ‡ï¼š<b>${t.config.target_count}</b>å— (ä¼˜å…ˆçº§)<br>ğŸ”¥ åºåˆ—ï¼š${seqStr}<br>âŒš æ—¶é—´ï¼š${tStr}`;
                        } else {
                            // æ™®é€šæ¨¡å¼
                            const pStr = (t.config.candidate_places || []).join(',');
                            const tStr = (t.config.target_times || []).join(',');
                            const modeStr = t.config.smart_continuous ? "è¿å·ä¼˜å…ˆ" : "æ™®é€šæ¨¡å¼";
                            detail = `ğŸ¯ ç›®æ ‡ï¼š<b>${t.config.target_count}</b>å— (${modeStr})<br>ğŸ¸ å€™é€‰ï¼š${pStr}å·<br>âŒš æ—¶é—´ï¼š${tStr}`;
                        }
                    } else if (t.items) {
                        // å…¼å®¹æ—§æ•°æ®
                        const itemsStr = t.items.map(i => `${i.place}å·${i.time}`).join(', ');
                        detail = `ğŸ¯ ç›®æ ‡ï¼š${itemsStr}`;
                    } else {
                        detail = "æ•°æ®æ ¼å¼é”™è¯¯";
                    }

                    const div = document.createElement('div');
                    div.className = 'task-item';
                    div.innerHTML = `
                <div>
                    <div class="task-info"><b>${desc}</b> è‡ªåŠ¨æŠ¢ <b>${dayDesc}</b> çš„åœº</div>
                    <div class="task-meta" style="color:#666;margin-top:5px;line-height:1.4;">${detail}</div>
                </div>
                <div style="display:flex;gap:5px;align-items:center;">
                    <button class="btn-manage" style="background:#34c759;font-size:12px;padding:4px 8px;" onclick="runTask('${t.id}')">âš¡ ç«‹å³è¿è¡Œ</button>
                    <button class="btn-del" onclick="deleteTask('${t.id}')">åˆ é™¤</button>
                </div>
            `;
                    list.appendChild(div);
                });
            } catch (e) { list.innerHTML = 'åŠ è½½å¤±è´¥'; }
        }

        async function runTask(id) {
            if (!confirm('ç¡®å®šè¦ç«‹å³æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡è¯¥ä»»åŠ¡å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`/api/tasks/${id}/run`, { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') alert('ä»»åŠ¡å·²è§¦å‘ï¼è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—');
                else alert('è§¦å‘å¤±è´¥: ' + data.msg);
            } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        function togglePlaceMode() {
            const mode = document.getElementById('placeMode').value;
            // å…ˆéšè—æ‰€æœ‰æ¨¡å¼ç‰¹å®šåŒºåŸŸ
            document.getElementById('modeNormal').style.display = 'none';
            document.getElementById('modePriority').style.display = 'none';
            document.getElementById('modeTimePriority').style.display = 'none';

            // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºå¯¹åº”åŒºåŸŸ
            if (mode === 'normal') {
                document.getElementById('modeNormal').style.display = 'block';
            } else if (mode === 'priority') {
                document.getElementById('modePriority').style.display = 'block';
            } else if (mode === 'time_priority') {
                document.getElementById('modeTimePriority').style.display = 'block';
            }

            // --- æ—¶é—´é€‰æ‹©å™¨é€»è¾‘ ---
            if (mode === 'time_priority') {
                // æ—¶é—´ä¼˜å…ˆï¼šæ˜¾ç¤ºè¾“å…¥æ¡†ï¼Œéšè—ç‚¹é€‰
                document.getElementById('timeSelector').style.display = 'none';
                document.getElementById('timeRangeArea').style.display = 'block';
                document.getElementById('timeLabelNormal').style.display = 'none';
                document.getElementById('timeLabelPriority').style.display = 'block';
            } else {
                // å…¶ä»–æ¨¡å¼ï¼ˆæ™®é€šã€åœºåœ°ä¼˜å…ˆï¼‰ï¼šæ˜¾ç¤ºç‚¹é€‰ï¼Œéšè—è¾“å…¥æ¡†
                document.getElementById('timeSelector').style.display = 'flex';
                document.getElementById('timeRangeArea').style.display = 'none';
                document.getElementById('timeLabelNormal').style.display = 'block';
                document.getElementById('timeLabelPriority').style.display = 'none';
            }
        }

        async function createTask() {
            const time = document.getElementById('taskTime').value;
            const type = document.getElementById('taskType').value;
            const offset = parseInt(document.getElementById('taskOffset').value);
            const targetCount = parseInt(document.getElementById('taskTargetCount').value);

            // æ”¶é›†æ—¶é—´
            const times = [];
            const placeMode = document.getElementById('placeMode').value; // æå‰è·å–æ¨¡å¼
            let priorityTimeSequences = []; // ç”¨äºæ—¶é—´ä¼˜å…ˆæ¨¡å¼çš„åºåˆ—ç»“æ„

            if (placeMode === 'time_priority') {
                const input = document.getElementById('timeRangeInput').value;
                const parts = input.split(/[,ï¼Œ]/);
                for (let part of parts) {
                    part = part.trim();
                    if (!part) continue;
                    let seq = [];
                    if (part.includes('-')) {
                        const [start, end] = part.split('-').map(s => parseInt(s));
                        if (!isNaN(start) && !isNaN(end)) {
                            for (let h = start; h < end; h++) {
                                seq.push(String(h).padStart(2, '0') + ":00");
                            }
                        }
                    } else {
                        const h = parseInt(part);
                        if (!isNaN(h)) seq.push(String(h).padStart(2, '0') + ":00");
                    }
                    if (seq.length > 0) {
                        priorityTimeSequences.push(seq);
                        // åŒæ—¶æŠŠæ‰€æœ‰æ—¶é—´åŠ å…¥ flat timesï¼Œç”¨äºå…¼å®¹æ˜¾ç¤º
                        times.push(...seq);
                    }
                }
                if (priorityTimeSequences.length === 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´æ®µï¼ä¾‹å¦‚: 13-15");
            } else {
                document.querySelectorAll('#timeSelector .active').forEach(btn => times.push(btn.innerText));
                if (times.length === 0) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¶é—´æ®µï¼");
            }

            // æ”¶é›†åœºåœ°é…ç½®
            let config = {
                target_times: times,
                priority_time_sequences: priorityTimeSequences, // æ–°å¢
                target_count: targetCount,
                mode: placeMode
            };

            if (placeMode === 'normal') {
                // æ™®é€šæ¨¡å¼ï¼šæ”¶é›†å€™é€‰æ±  + æ™ºèƒ½å¼€å…³
                const places = [];
                document.querySelectorAll('#placeSelector .active').forEach(btn => places.push(btn.innerText.replace('å·', '')));
                if (places.length === 0) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå€™é€‰åœºåœ°ï¼");

                config.candidate_places = places;
                config.smart_continuous = document.getElementById('taskSmartMode').checked;
            } else if (placeMode === 'time_priority') {
                // æ—¶é—´ä¼˜å…ˆæ¨¡å¼
                const places = [];
                document.querySelectorAll('#placeSelectorTime .active').forEach(btn => places.push(btn.innerText.replace('å·', '')));
                // è¿™é‡Œå¦‚æœä¸é€‰ï¼Œä»£è¡¨å…¨åœºæ‰«æï¼Œæ‰€ä»¥ä¸éœ€è¦å¼ºåˆ¶æ ¡éªŒé•¿åº¦
                config.candidate_places = places;
            } else {
                // ä¼˜å…ˆçº§æ¨¡å¼ï¼šæ”¶é›†åºåˆ—å­—ç¬¦ä¸²
                const rawInput = document.getElementById('priorityInput').value.trim();
                if (!rawInput) return alert("è¯·è¾“å…¥ä¼˜å…ˆçº§åºåˆ—ï¼");

                // è§£æåºåˆ—: "6-7, 8-9" -> [["6","7"], ["8","9"]]
                const sequences = [];
                const parts = rawInput.split(/[,ï¼Œ]/); // æ”¯æŒä¸­è‹±æ–‡é€—å·
                for (let p of parts) {
                    p = p.trim();
                    if (!p) continue;
                    // æ”¯æŒ "6-7" æˆ– "6+7" æˆ– "6 7"
                    const sub = p.split(/[-+ ]/).filter(x => x.trim());
                    if (sub.length > 0) sequences.push(sub);
                }

                if (sequences.length === 0) return alert("ä¼˜å…ˆçº§åºåˆ—æ ¼å¼é”™è¯¯ï¼");
                config.priority_sequences = sequences;
                config.allow_partial = document.getElementById('taskAllowPartial').checked;
            }

            const task = {
                run_time: time,
                type: type,
                target_day_offset: offset,
                config: config,
                weekly_day: type === 'weekly' ? new Date(currentDate).getDay() - 1 : 0
            };
            if (task.weekly_day < 0) task.weekly_day = 6;

            try {
                // ä¿å­˜å…¨å±€é…ç½®ï¼ˆæ‰‹æœºå·ï¼‰
                await saveConfig();

                await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(task)
                });
                alert('ä»»åŠ¡å·²æ·»åŠ ï¼');
                loadTasks();
            } catch (e) { alert('æ·»åŠ å¤±è´¥'); }
        }

        async function deleteTask(id) {
            if (!confirm('ç¡®å®šåˆ é™¤?')) return;
            await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
            loadTasks();
        }
    </script>

</body>

</html>