<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—å¤–ä½“è‚²é¦†å¯è§†æŠ¢ç¥¨</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f7;
        }

        .container {
            width: min(96vw, 1500px);
            max-width: 1500px;
            margin: 0 auto;
            padding-bottom: 120px;
        }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .clock {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .btn-manage {
            background: #5856d6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* æ—¥æœŸé€‰æ‹© */
        .date-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .date-btn {
            flex: 0 0 auto;
            padding: 10px 15px;
            border: none;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: 0.2s;
        }

        .date-btn.active {
            background: #007aff;
            color: white;
            font-weight: bold;
        }

        /* çŸ©é˜µ */
        .matrix-container {
            overflow-x: hidden;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .matrix-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #666;
            background: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 999px;
            padding: 4px 8px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .matrix-table-view {
            display: block;
        }

        .matrix-card-view {
            display: none;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
        }

        th,
        td {
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #eee;
        }

        th {
            background: #fafafa;
            color: #666;
            font-size: 12px;
            font-weight: 700;
        }

        td:first-child,
        th:first-child {
            width: 74px;
            font-size: 12px;
            font-weight: 700;
        }

        /* çŠ¶æ€æ ¼å­ */
        .cell {
            width: 100%;
            max-width: 34px;
            height: 26px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
            margin: 0 auto;
        }

        .cell.available {
            background-color: #34c759;
        }

        .cell.booked {
            background-color: #ff3b30;
            cursor: not-allowed;
            opacity: 0.3;
        }

        .cell.locked {
            background-color: #8e8e93;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .cell.occupied {
            background-color: #ff3b30;
            cursor: not-allowed;
            opacity: 0.3;
        }

        .cell.mine {
            background-color: #5ac8fa;
            cursor: not-allowed;
            opacity: 0.9;
        }

        .cell.selected {
            background-color: #007aff;
            box-shadow: 0 0 0 2px #0056b3 inset;
            transform: scale(0.9);
        }

        .time-card {
            border: 1px solid #ececec;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            background: #fff;
        }

        .time-card-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #444;
        }

        .time-card-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 6px;
        }

        .place-pill {
            border: none;
            border-radius: 8px;
            padding: 7px 4px;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            transition: 0.2s;
        }

        .place-pill.available {
            background: #34c759;
        }

        .place-pill.occupied {
            background: #ff3b30;
            opacity: 0.45;
            cursor: not-allowed;
        }

        .place-pill.locked {
            background: #8e8e93;
            opacity: 0.75;
            cursor: not-allowed;
        }

        .place-pill.mine {
            background: #5ac8fa;
            cursor: not-allowed;
        }

        .place-pill.selected {
            background: #007aff;
            box-shadow: inset 0 0 0 2px #0056b3;
        }

        /* å·²é€‰æ ‡ç­¾ */
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            max-height: 80px;
            overflow-y: auto;
        }

        .tag {
            background: #e3f2fd;
            color: #007aff;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .tag-close {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.6;
        }

        .tag-close:hover {
            opacity: 1;
            color: #ff3b30;
        }

        /* åº•éƒ¨æ  */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-sizing: border-box;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .bar-content {
            max-width: 1500px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .info {
            font-size: 16px;
            font-weight: bold;
        }

        .timer-box {
            background: #f0f0f5;
            min-width: 0;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .timer-input {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            width: 80px;
            font-family: monospace;
        }

        .btn {
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-danger {
            background: #ff3b30;
            color: white;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-title {
            font-weight: bold;
            font-size: 18px;
        }

        .modal-close {
            cursor: pointer;
            font-size: 20px;
            color: #999;
        }

        .task-form {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-item {
            background: white;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .task-main {
            flex: 1;
            min-width: 0;
        }

        .task-actions {
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .task-info {
            font-size: 14px;
        }

        .task-meta {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .btn-del {
            color: #ff3b30;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        /* æ–°å¢ï¼šå¼¹çª—å†…çš„æ ‡ç­¾é€‰æ‹©å™¨ */
        .tag-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .tag-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            color: #333;
            transition: 0.2s;
        }

        .tag-btn.active {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }

        /* æ–°å¢ Tab æ ·å¼ */
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: 0.2s;
        }

        .tab-btn:hover {
            color: #007aff;
            background: #f9f9f9;
        }

        .tab-btn.active {
            color: #007aff;
            border-bottom-color: #007aff;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .container,
            .bar-content {
                width: 100%;
                max-width: 100%;
            }

            .matrix-container {
                overflow-x: hidden;
                padding: 10px;
            }

            .date-scroll {
                overflow-x: auto;
            }

            .matrix-table-view {
                display: none;
            }

            .matrix-card-view {
                display: block;
            }

            .time-card-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .control-row {
                flex-direction: column;
                align-items: stretch;
            }

            .timer-box {
                width: 100%;
                flex-wrap: wrap;
            }
        }

        .toast-msg {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #34c759;
            color: #fff;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        .toast-msg.error { background: #ff3b30; }

    </style>
</head>

<body>

    <div class="container">
        <div class="top-bar">
            <h2>ğŸ¸ æŠ¢ç¥¨åŠ©æ‰‹</h2>
            <div>
                <span id="sys-clock" class="clock" style="font-size:16px;margin-right:10px;">--:--:--.---</span>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tabs">
            <div class="tab-btn {% if page_mode == 'semi' %}active{% endif %}" onclick="window.location.href='/'">ğŸ–ï¸ åŠè‡ªåŠ¨æŠ¢ç¥¨</div>
            <div class="tab-btn {% if page_mode == 'tasks' %}active{% endif %}" onclick="window.location.href='/tasks'">ğŸ“‹ ä»»åŠ¡ä¸­å¿ƒ</div>
            <div class="tab-btn {% if page_mode == 'settings' %}active{% endif %}" onclick="window.location.href='/settings'">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
        </div>

        <!-- Tab 1: åŠè‡ªåŠ¨æŠ¢ç¥¨ (åŸä¸»é¡µå†…å®¹) -->
        {% if page_mode == 'semi' %}
        <div id="tab-semi-auto" class="tab-content active">
            <div class="date-scroll">
                {% for d in dates %}
                <button class="date-btn {% if loop.index0 == 0 %}active{% endif %}"
                    onclick="selectDate('{{ d.val }}', this)">
                    <div style="font-size:12px;color:#666;">{{ d.weekday }}</div>
                    <div style="font-size:16px;font-weight:bold;">{{ d.date_only }}</div>
                </button>
                {% endfor %}
            </div>

            <div id="matrix-area">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        {% endif %}

        <!-- Tab 2: ä»»åŠ¡ä¸­å¿ƒ -->
        {% if page_mode == 'tasks' %}
        <div id="tab-auto-plan" class="tab-content active">
            <div class="task-form">
                <div
                    style="background:#e3f2fd;color:#0056b3;padding:10px;border-radius:6px;font-size:13px;margin-bottom:15px;">
                    <b>ğŸ’¡ æç¤ºï¼š</b> åªè¦è®¾ç½®å¥½ï¼Œç³»ç»Ÿå°±ä¼šæŒ‰æ—¶å¸®æ‚¨æŠ¢ã€‚ä¸éœ€è¦ç®¡ç°åœ¨æœ‰æ²¡æœ‰ç©ºåœºã€‚
                </div>

                <!-- ç¬¬ä¸€è¡Œï¼šæ—¶é—´å’Œé¢‘ç‡ -->
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <div class="form-group" style="flex:1;min-width:160px;">
                        <label>â° è§¦å‘æ—¶é—´</label>
                        <input type="time" id="taskTime" class="form-control" step="1" value="08:00:00"
                            onchange="updateTaskDateSelector();updateTaskSummary()">
                    </div>

                    <div class="form-group" style="flex:1;min-width:140px;">
                        <label>ğŸ” é¢‘ç‡</label>
                        <select id="taskType" class="form-control" onchange="onTaskTypeChange();updateTaskSummary()">
                            <option value="daily">æ¯å¤©æ‰§è¡Œ</option>
                            <option value="weekly">æ¯å‘¨æ‰§è¡Œ</option>
                            <option value="once">åªæ‰§è¡Œä¸€æ¬¡</option>
                        </select>

                    </div>

                    <!-- åªæœ‰é€‰æ‹©â€œæ¯å‘¨æ‰§è¡Œâ€æ—¶æ‰æ˜¾ç¤º -->
                    <div class="form-group" id="weeklyDayGroup"
                         style="flex:1;min-width:140px;display:none;">
                        <label>ğŸ“† å‘¨å‡ æ‰§è¡Œ</label>
                        <select id="weeklyDay" class="form-control" onchange="updateTaskDateSelector();updateTaskSummary()">
                            <option value="0">å‘¨ä¸€</option>
                            <option value="1">å‘¨äºŒ</option>
                            <option value="2">å‘¨ä¸‰</option>
                            <option value="3">å‘¨å››</option>
                            <option value="4">å‘¨äº”</option>
                            <option value="5">å‘¨å…­</option>
                            <option value="6">å‘¨æ—¥</option>
                        </select>
                    </div>
                </div>


                <!-- æ—¥æœŸé€‰æ‹© -->
                <div class="form-group">
                    <label>ğŸ“… æŠ¢å“ªå¤©çš„åœºï¼Ÿ</label>
                    <div id="targetDateList"
                        style="display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;margin-top:5px;">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <input type="hidden" id="taskOffset" value="2">
                </div>

                <!-- åœºåœ°é€‰æ‹©åŒºåŸŸ -->
                <div class="form-group" style="border:1px solid #eee;padding:10px;border-radius:8px;background:white;">
                    <label style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
                        <span>ğŸ¸ åœºåœ°é€‰æ‹©æ¨¡å¼</span>
                        <select id="placeMode" style="padding:4px;font-size:12px;" onchange="togglePlaceMode()">
                            <option value="normal">ğŸ¯ æ™®é€šå¤šé€‰</option>
                        </select>
                    </label>

                    <!-- æ¨¡å¼A: æ™®é€šé€‰åœº -->
                    <div id="modeNormal">
                        <div class="tag-selector" id="placeSelector">
                            <!-- JS ç”Ÿæˆ 1-17å· -->
                        </div>
                        <div style="margin-top:10px;padding-top:10px;border-top:1px dashed #eee;">
                            <label style="font-size:12px;color:#666;">
                                <input type="checkbox" id="taskSmartMode" checked>
                                <b>æ™ºèƒ½è¿å·ä¼˜å…ˆ</b> (è‡ªåŠ¨æ‰¾ 6+7, 8+9...)
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ¯ æ€»ç›®æ ‡æ•°é‡ (éœ€è¦æŠ¢åˆ°å¤šå°‘å—åœºåœ°)</label>
                <select id="taskTargetCount" class="form-control">
                    <option value="1">1</option>
                    <option value="2" selected>2</option>
                    <option value="3">3</option>
                </select>
            </div>

            <!-- æ—¶é—´é€‰æ‹©å™¨ -->
            <div class="form-group">
                <label id="timeLabelNormal">âŒš é€‰æ‹©æ—¶é—´æ®µ (å¯å¤šé€‰ï¼Œç³»ç»Ÿä¼šå°è¯•å‡‘å¤Ÿæ€»ç›®æ ‡æ•°é‡)</label>
                <label id="timeLabelPriority" style="display:none">âŒš è¾“å…¥ä¼˜å…ˆæ—¶é—´æ®µ (ä¾‹å¦‚ 13-15)</label>

                <div class="tag-selector" id="timeSelector">
                    <!-- JS ç”Ÿæˆ 10:00-22:00 -->
                </div>

                <!-- é€šçŸ¥æ‰‹æœºå·ï¼ˆå½“å‰ä»»åŠ¡ä¸“ç”¨ï¼‰ -->
                <div class="form-group">
                    <label>ğŸ“± é€šçŸ¥æ‰‹æœºå· (æœ¬ä»»åŠ¡ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”)</label>
                    <input type="text" id="notificationPhones" class="form-control"
                           placeholder="ä¾‹å¦‚: 13800000000, 13900000000">
                </div>
                <div class="form-group">
                    <label>ğŸ’¬ å¾®ä¿¡é€šçŸ¥ Token (æœ¬ä»»åŠ¡ï¼ŒPushPlusï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”)</label>
                    <input type="text" id="taskPushplusTokens" class="form-control"
                           placeholder="ä¾‹å¦‚: xxxxxxxxxxxxxxxx, yyyyyyyyyyyyyyyy">
                </div>

                <div id="timeRangeArea" style="display:none">
                    <input type="text" id="timeRangeInput" class="form-control" placeholder="ä¾‹å¦‚: 13-15, 18-20"
                        style="font-family:monospace;">
                    <div style="font-size:12px;color:#999;margin-top:5px;">
                        * æ ¼å¼è¯´æ˜ï¼šè¾“å…¥ "13-15" ä»£è¡¨é¢„å®š 13:00 åˆ° 15:00 æœŸé—´çš„åœºæ¬¡ï¼ˆå³13:00å’Œ14:00ï¼‰ã€‚<br>
                        * å¤šä¸ªæ—¶é—´æ®µç”¨é€—å·åˆ†éš”ã€‚
                    </div>
                </div>
            </div>

            <div style="margin-top:15px;padding-top:10px;border-top:1px dashed #ddd;font-size:13px;color:#007aff;font-weight:bold;margin-bottom:10px;"
                id="taskSummary">
                è¯·é…ç½®ä»»åŠ¡...
            </div>

            <button class="btn btn-primary" id="saveTaskBtn" style="width:100%" onclick="createTask()">âœ… ä¿å­˜è®¡åˆ’</button>
        </div>

        <div class="task-list" id="taskList">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div style="font-size:12px;color:#666;margin-top:8px;">
            â€œâš¡ ç«‹å³è¿è¡Œâ€æŒ‰é’®ç”¨äº<strong>ç«‹åˆ»æ‰§è¡Œä¸€æ¬¡è¯¥ä»»åŠ¡</strong>ï¼Œä¸å¿…ç­‰å¾…è®¡åˆ’æ—¶é—´åˆ°ç‚¹ã€‚
        </div>
        </div>
        {% endif %}
        <!-- Tab 3: ç³»ç»Ÿè®¾ç½® -->
        {% if page_mode == 'settings' %}
        <div id="tab-settings" class="tab-content active">
        <!-- é€Ÿåº¦è®¾ç½® -->
        <div class="form-group"
            style="margin-top:10px;border:1px solid #eee;padding:10px;border-radius:8px;background:white;">
            <label style="font-weight:bold;margin-bottom:8px;">âš¡ æŠ¢ç¥¨é€Ÿåº¦è®¾ç½® (æ¯«ç§’)</label>
            <div style="display:flex;gap:10px;">
                <div style="flex:1">
                    <label style="font-size:12px;">æ™®é€šé‡è¯•é—´éš”</label>
                    <input type="number" id="retryInterval" class="form-control" value="0.5" step="0.1"
                        min="0.1">
                </div>
                <div style="flex:1">
                    <label style="font-size:12px;color:#ff3b30;">ğŸ”¥ æ­»ç£•æ¨¡å¼é—´éš”</label>
                    <input type="number" id="aggressiveRetryInterval" class="form-control" value="0.3"
                        step="0.1" min="0.1">
                </div>
            </div>
            <div style="font-size:12px;color:#999;margin-top:5px;">
                * æ­»ç£•æ¨¡å¼ï¼šå½“æ£€æµ‹åˆ°æœåŠ¡å™¨å´©æºƒ/404æ—¶å¯ç”¨çš„æé€Ÿé‡è¯•é¢‘ç‡ã€‚<br>
                * å»ºè®®å€¼ï¼šæ™®é€š 0.5sï¼Œæ­»ç£• 0.3sã€‚å¤ªå¿«å¯èƒ½ä¼šè¢«å°IPã€‚
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:8px;">
          <div style="flex:1">
            <label>é”å®šçŠ¶æ€é‡è¯•é—´éš” (ç§’)</label>
            <input type="number"
                   id="lockedRetryInterval"
                   class="form-control"
                   step="0.1"
                   min="0.1"
                   placeholder="ä¾‹å¦‚ 0.5">
          </div>
          <div style="flex:1">
            <label>é”å®šçŠ¶æ€æœ€å¤šåˆ· N ç§’</label>
            <input type="number"
                   id="lockedMaxSeconds"
                   class="form-control"
                   step="1"
                   min="1"
                   placeholder="ä¾‹å¦‚ 10">
          </div>
        </div>


        <!-- å…¨å±€é€šçŸ¥æ‰‹æœºå· + ä¿å­˜é…ç½® -->
        <div class="form-group"
             style="margin-top:10px;border:1px solid #eee;padding:10px;border-radius:8px;background:white;">
            <label style="font-weight:bold;margin-bottom:8px;">
                ğŸ“¢ å…¨å±€é€šçŸ¥æ‰‹æœºå· (Tokenå¤±æ•ˆ / ç³»ç»Ÿå¼‚å¸¸æŠ¥è­¦)
            </label>
            <div style="display:flex;gap:10px;">
                <input type="text" id="globalNotificationPhones" class="form-control"
                       placeholder="ä¾‹å¦‚: 13800000000, 13900000000">
                <button class="btn" style="padding:6px 12px;font-size:12px;background:#eee;"
                        onclick="testSMS()">ğŸ“¡ æµ‹è¯•</button>
            </div>
            <div style="font-size:12px;color:#999;margin-top:5px;">
                * è¿™é‡Œå¡«å†™çš„æ˜¯â€œå…¨å±€æŠ¥è­¦æ‰‹æœºå·â€ï¼Œç”¨äº Token å¤±æ•ˆ / æœåŠ¡å™¨å´©æºƒ ç­‰ç³»ç»Ÿçº§æé†’ã€‚<br>
                * æ¯ä¸ªè‡ªåŠ¨ä»»åŠ¡ä¸Šé¢çš„â€œé€šçŸ¥æ‰‹æœºå·â€åªè´Ÿè´£è¯¥ä»»åŠ¡è®¢åœºæˆåŠŸåçš„çŸ­ä¿¡ã€‚
            </div>
        </div>
        <div class="form-group"
             style="margin-top:10px;border:1px solid #eee;padding:10px;border-radius:8px;background:white;">
            <label style="font-weight:bold;margin-bottom:8px;">
                ğŸ’¬ å…¨å±€å¾®ä¿¡é€šçŸ¥ Token (PushPlus)
            </label>
            <div style="display:flex;gap:10px;">
                <input type="text" id="globalPushplusTokens" class="form-control"
                       placeholder="ä¾‹å¦‚: xxxxxxxxxxxxxxxx, yyyyyyyyyyyyyyyy">
            </div>
            <div style="font-size:12px;color:#999;margin-top:5px;">
                * è¿™é‡Œå¡«å†™çš„æ˜¯â€œå…¨å±€å¾®ä¿¡é€šçŸ¥ tokenâ€ï¼Œç”¨äºå¥åº·æ£€æŸ¥ç­‰ç³»ç»Ÿçº§æé†’ã€‚<br>
                * æ¯ä¸ªè‡ªåŠ¨ä»»åŠ¡ä¸Šé¢çš„â€œå¾®ä¿¡é€šçŸ¥ tokenâ€åªè´Ÿè´£è¯¥ä»»åŠ¡è®¢åœºç»“æœæé†’ã€‚
            </div>
        </div>

        <!-- å¥åº·æ£€æŸ¥ -->
        <div class="form-group">
            <label>å¥åº·æ£€æŸ¥</label>
            <input type="checkbox" id="healthCheckEnabled" onchange="updateTaskSummary()" />
            <label for="healthCheckEnabled">å¯ç”¨å¥åº·æ£€æŸ¥</label>
            <br />
            <label>å¥åº·æ£€æŸ¥å¼€å§‹æ—¶é—´ (HH:MM)</label>
            <input type="time" id="healthCheckStartTime" value="00:00" onchange="updateTaskSummary()" />
            <br />
            <label>å¥åº·æ£€æŸ¥é—´éš” (åˆ†é’Ÿ)</label>
            <input type="number" id="healthCheckInterval" value="30" min="1" onchange="updateTaskSummary()" />
        </div>


        <!-- Token æ£€æŸ¥ä¸æ›´æ–° -->
        <div class="form-group"
            style="margin-top:5px;border:1px solid #eee;padding:10px;border-radius:8px;background:white;">
            <label style="margin-bottom:8px;font-weight:bold;">ğŸ”‘ å‡­è¯ç®¡ç†</label>

            <button class="btn"
                style="width:100%;padding:8px;font-size:13px;background:#f0f0f5;color:#333;border:1px solid #ddd;margin-bottom:10px;"
                onclick="checkToken()">ğŸ” æ£€æŸ¥å‡­è¯çŠ¶æ€ï¼ˆæŸ¥è¯¢/ä¸‹å•ï¼‰</button>

            <div id="authUpdateArea" style="display:none;">
                <textarea id="newToken" class="form-control" placeholder="ç²˜è´´æ–°çš„ token (oy9...)" rows="1"
                    style="margin-bottom:5px;font-size:12px;"></textarea>
                <textarea id="newCookie" class="form-control" placeholder="å¯é€‰ï¼šç²˜è´´æ–°çš„ cookieï¼ˆç•™ç©ºåˆ™ä¿ç•™å½“å‰å€¼ï¼‰"
                    rows="2" style="margin-bottom:5px;font-size:12px;"></textarea>
                <div style="font-size:12px;color:#666;margin:4px 0 8px 0;">
                    è¯´æ˜ï¼šå¤šæ•°æ¥å£ä»…éœ€ Tokenï¼›å½“é‡åˆ°ç‰¹å®šæ¥å£é‰´æƒå¼‚å¸¸æ—¶å†è¡¥å…… Cookieã€‚
                </div>
                <button class="btn btn-success" style="width:100%;padding:6px;font-size:13px;"
                    onclick="updateAuth()">ğŸ’¾ ä¿å­˜å¹¶æ›´æ–°</button>
            </div>

            <div style="text-align:center;">
                <a href="javascript:void(0)"
                    onclick="document.getElementById('authUpdateArea').style.display='block';this.style.display='none'"
                    style="font-size:12px;color:#007aff;text-decoration:none;">âœï¸ æˆ‘è¦æ›´æ–° Token</a>
            </div>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:flex-end;">
            <button class="btn btn-success" style="padding:8px 16px;font-size:13px;" onclick="saveConfig()">ğŸ’¾ ä¿å­˜å…¨éƒ¨ç³»ç»Ÿè®¾ç½®</button>
        </div>

        <div class="form-group" style="margin-top:10px;border:1px solid #eee;padding:10px;border-radius:8px;background:white;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <label style="font-weight:bold;">ğŸ“Ÿ è¿è¡Œæ—¥å¿—ï¼ˆä¸åå° /api/logs åŒæºï¼‰</label>
                <button class="btn" style="padding:6px 12px;font-size:12px;background:#333;color:#fff;" onclick="toggleLogConsole()">åˆ‡æ¢æ˜¾ç¤º</button>
            </div>
            <div id="logConsole" style="
                height: 180px;
                background: #1e1e1e;
                color: #00ff00;
                font-family: monospace;
                font-size: 12px;
                padding: 10px;
                overflow-y: auto;
                display: none;
                border-radius: 6px;
            ">
                <div id="logContent"></div>
            </div>
        </div>
        {% endif %}
    </div>

    </div>

    <!-- åº•éƒ¨æ  (åªåœ¨åŠè‡ªåŠ¨é¡µé¢æ˜¾ç¤º) -->
    <div class="bottom-bar" id="bottomBar" {% if page_mode != 'semi' %}style="display:none"{% endif %}>
        <div class="bar-content">
            <div class="selected-tags" id="tagList"></div>
            <div class="status-row">
                <div class="info">å·²é€‰: <span id="count" style="color:#007aff">0</span> ä¸ªåœºåœ°</div>
                <div class="clock" id="countdown"></div>
            </div>
            <div class="control-row">
                <div class="timer-box">
                    <label><input type="checkbox" id="timerEnable" onchange="toggleTimer()"> å®šæ—¶æŠ¢ç¥¨</label>
                    <input type="datetime-local" id="timerInput" class="form-control"
                        style="width:200px;font-size:13px;padding:2px;" disabled>
                </div>
                <button class="btn btn-primary" id="btnNow" onclick="submitOrder(false)" disabled>ç«‹å³ä¸‹å•</button>
                <button class="btn btn-success" id="btnTimer" onclick="startTimer()"
                    style="display:none;">å¯åŠ¨å€’è®¡æ—¶</button>
                <button class="btn btn-danger" id="btnStop" onclick="stopTimer()" style="display:none;">åœæ­¢</button>
            </div>
        </div>
    </div>

    <div id="saveToast" class="toast-msg"></div>

    <script>
        let currentDate = '{{ dates[0].val }}';
        let selectedItems = new Set();
        let timerInterval = null;
        let isTimerRunning = false;
        let serverOffset = 0;
        let cachedPlaces = []; // å­˜å‚¨åç«¯è¿”å›çš„åœºåœ°åˆ—è¡¨
        let latestPlaces = [];
        let latestTimes = [];
        let latestCellStatus = {};
        let lastLogIndex = 0; // è®°å½•æ—¥å¿—ä½ç½®
        let editingTaskId = null;
        const PAGE_MODE = '{{ page_mode }}';

        function showToast(msg, isError = false) {
            const toast = document.getElementById('saveToast');
            if (!toast) return;
            toast.textContent = msg;
            toast.classList.toggle('error', !!isError);
            toast.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => {
                toast.style.display = 'none';
            }, 2200);
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('saveToast');
            if (!toast) return;
            toast.textContent = msg;
            toast.classList.toggle('error', !!isError);
            toast.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => {
                toast.style.display = 'none';
            }, 2200);
        }

        function toggleLogConsole() {
            const console = document.getElementById('logConsole');
            if (!console) return;
            if (console.style.display === 'none') {
                console.style.display = 'block';
            } else {
                console.style.display = 'none';
            }
        }

        async function pollLogs() {
            try {
                const res = await fetch('/api/logs');
                const logs = await res.json();
                if (logs.length > lastLogIndex) {
                    const newLogs = logs.slice(lastLogIndex);
                    const content = document.getElementById('logContent');
                    if (!content) return;
                    newLogs.forEach(line => {
                        const div = document.createElement('div');
                        div.innerText = line;
                        content.appendChild(div);
                    });
                    lastLogIndex = logs.length;
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    const c = document.getElementById('logConsole');
                    c.scrollTop = c.scrollHeight;
                }
            } catch (e) { }
        }

        function switchTab(tabId, btn) {
            // åˆ‡æ¢ Tab å†…å®¹
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // åˆ‡æ¢æŒ‰é’®æ ·å¼
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');

            // åº•éƒ¨æ åªåœ¨åŠè‡ªåŠ¨æ¨¡å¼æ˜¾ç¤º
            const bar = document.getElementById('bottomBar');
            if (tabId === 'semi-auto') {
                bar.style.display = 'block';
            } else {
                bar.style.display = 'none';
            }

            const logConsole = document.getElementById('logConsole');
            if (logConsole && tabId !== 'settings') {
                logConsole.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–
        if (document.getElementById('matrix-area')) loadMatrix(currentDate);
        syncTime();
        setInterval(updateClock, 30);
        {% if page_mode == 'settings' %}
        setInterval(pollLogs, 1000); // æ¯ç§’è½®è¯¢æ—¥å¿—
        {% endif %}

        // åˆå§‹åŒ–ä»»åŠ¡åŒºåŸŸ (é¡µé¢åŠ è½½æ—¶ç›´æ¥è°ƒç”¨)
        if (document.getElementById('targetDateList')) initDateSelector();
        // initPlaceSelector ç§»åˆ° renderTable ä¹‹åè°ƒç”¨ï¼Œæˆ–è€…ç»™ä¸ªé»˜è®¤è°ƒç”¨
        if (document.getElementById('placeSelector')) initPlaceSelector();
        if (document.getElementById('timeSelector')) initTimeSelector();
        if (document.getElementById('taskList')) loadTasks();
        loadConfig();
        if (document.getElementById('taskSummary')) updateTaskSummary();
        if (document.getElementById('taskType')) onTaskTypeChange();

        // ... (ä¹‹å‰çš„ syncTime, updateClock, selectDate, loadMatrix, renderTable, toggleCell ä¿æŒä¸å˜) ...
        // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå¤ç”¨ä¹‹å‰çš„é€»è¾‘ï¼Œåªå¢åŠ æ–°åŠŸèƒ½çš„JS

        async function syncTime() {
            const start = Date.now();
            try {
                const res = await fetch('/api/time');
                const data = await res.json();
                const end = Date.now();
                const serverTime = data.timestamp * 1000;
                serverOffset = serverTime - end + (end - start) / 2;
            } catch (e) { }
        }

        function updateClock() {
            const now = new Date(Date.now() + serverOffset);
            const timeStr = now.toLocaleTimeString('en-GB') + '.' + String(now.getMilliseconds()).padStart(3, '0');
            document.getElementById('sys-clock').innerText = timeStr;

            if (isTimerRunning) {
                const targetVal = document.getElementById('timerInput').value; // "2026-01-09T08:00"
                if (!targetVal) return;

                const targetTime = new Date(targetVal).getTime();
                const currentTime = now.getTime();

                // å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
                const diff = (targetTime - currentTime) / 1000;

                if (diff <= 0) {
                    stopTimer();
                    submitOrder(true);
                } else {
                    let info = "";
                    if (diff > 3600) info = `> ${Math.floor(diff / 3600)}å°æ—¶`;
                    else if (diff > 60) info = `${Math.floor(diff / 60)}åˆ†${Math.floor(diff % 60)}ç§’`;
                    else info = diff.toFixed(1) + "ç§’";

                    document.getElementById('countdown').innerText = `â³ å€’è®¡æ—¶: ${info}`;
                    document.getElementById('countdown').style.color = "#ff9500";
                }
            } else {
                document.getElementById('countdown').innerText = "";
            }
        }

        function selectDate(date, btn) {
            currentDate = date;
            document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadMatrix(date);
            selectedItems.clear();
            updateBar();
        }

        async function loadMatrix(date) {
            const area = document.getElementById('matrix-area');
            area.innerHTML = '<div class="loading">æ­£åœ¨è·å–åœºåœ°çŠ¶æ€...</div>';
            try {
                const res = await fetch(`/api/matrix?date=${date}`);
                const data = await res.json();
                if (data.error) { area.innerHTML = `<div style="color:red;text-align:center">${data.error}</div>`; return; }
                renderTable(data);
            } catch (e) { area.innerHTML = `<div style="color:red;text-align:center">ç½‘ç»œé”™è¯¯</div>`; }
        }

        function renderTable(data) {
            const { places, times, matrix } = data;
            cachedPlaces = places; // æ›´æ–°ç¼“å­˜

            // è®¡ç®—æ—¥æœŸåç§»é‡
            let forceAvailable = false;
            try {
                const parts = currentDate.split('-');
                const target = new Date(parts[0], parts[1] - 1, parts[2]);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffTime = target - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                // ç”¨æˆ·éœ€æ±‚ï¼š7å¤©ä¹‹åï¼ˆåŒ…æ‹¬ä»Šå¤©ï¼‰-> ç†è§£ä¸ºä»ç¬¬7å¤©å¼€å§‹ (Offset >= 6)
                if (diffDays >= 6) {
                    forceAvailable = true;
                }
            } catch (e) { console.error(e); }

            // æ ¸å¿ƒä¿®å¤é€»è¾‘ï¼šä¼˜å…ˆæ˜¾ç¤ºçœŸå®æ•°æ®
            // åªæœ‰å½“æ²¡æœ‰çœŸå®æ•°æ®ï¼Œä¸”å¤„äºè¿œæœŸæ¨¡å¼æ—¶ï¼Œæ‰å¯ç”¨å‡æ•°æ®ï¼ˆæ„¿æœ›å•æ¨¡å¼ï¼‰
            const hasRealData = data && data.matrix && Object.keys(data.matrix).length > 0;
            let isFakeMode = false;

            if (!hasRealData && forceAvailable) {
                isFakeMode = true;

                // 1) åœºåœ°åˆ—è¡¨ï¼šä¼˜å…ˆç”¨åç«¯è¿”å›çš„ placesï¼Œæ²¡æœ‰å°±å…œåº• 1â€“17 å·
                let fakePlaces;
                if (Array.isArray(data.places) && data.places.length > 0) {
                    fakePlaces = data.places.map(String);
                } else {
                    fakePlaces = Array.from({ length: 17 }, (_, i) => String(i + 1));
                    data.places = fakePlaces;
                }

                // 2) æ—¶é—´åˆ—è¡¨ï¼šä¼˜å…ˆç”¨åç«¯è¿”å›çš„ timesï¼Œæ²¡æœ‰å°±å…œåº• 10:00â€“21:00
                let fakeTimes;
                if (Array.isArray(data.times) && data.times.length > 0) {
                    fakeTimes = data.times.slice();
                } else {
                    // å’Œç³»ç»Ÿå…¶å®ƒåœ°æ–¹ä¿æŒä¸€è‡´ï¼š10:00, 11:00, ..., 21:00
                    fakeTimes = Array.from(
                        { length: 12 },
                        (_, i) => String(i + 10).padStart(2, '0') + ':00'
                    );
                    data.times = fakeTimes;
                }

                // 3) æ„é€ ä¸€ä»½â€œå…¨éƒ¨å¯é€‰â€çš„ matrix
                data.matrix = {};
                fakePlaces.forEach(p => {
                    data.matrix[p] = {};
                    fakeTimes.forEach(t => {
                        data.matrix[p][t] = 'available';
                    });
                });

                // 4) åŒæ­¥åˆ°è§£æ„å‡ºæ¥çš„å±€éƒ¨å˜é‡ places / times
                places.length = 0;
                places.push(...fakePlaces);

                times.length = 0;
                times.push(...fakeTimes);
            }

            // å†æ¬¡æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
            if (!data.matrix || Object.keys(data.matrix).length === 0) {
                document.getElementById('matrix-area').innerHTML = '<div style="text-align:center;padding:20px;color:#999">æš‚æ— æ•°æ® (æœªå¼€æ”¾)</div>';
                return;
            }

            // çŠ¶æ€æç¤ºæ¡
            let statusHtml = '';
            if (isFakeMode) {
                statusHtml = '<div style="background:#fff3cd;color:#856404;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:10px;border:1px solid #ffeeba;">âš ï¸ <b>æ„¿æœ›å•æ¨¡å¼</b>ï¼šç³»ç»Ÿæœªè·å–åˆ°è¯¥æ—¥æœŸçš„å®æ—¶æ•°æ®ï¼ˆå¯èƒ½æ˜¯å°šæœªå¼€æ”¾æˆ–ç½‘ç»œæ³¢åŠ¨ï¼‰ã€‚æ‚¨å¯ä»¥ç»§ç»­é€‰åº§ï¼Œç³»ç»Ÿä¼šåœ¨ä»»åŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨å°è¯•æŠ¢è¿™äº›ä½ç½®ã€‚</div>';
            } else {
                statusHtml = '<div style="background:#d4edda;color:#155724;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:10px;border:1px solid #c3e6cb;">âœ… <b>å®æ—¶æ•°æ®</b>ï¼šå½“å‰æ˜¾ç¤ºçš„æ˜¯æœ€æ–°çš„åœºåœ°çŠ¶æ€ã€‚</div>';
            }

            const meta = data.meta || {};
            let mineSyncHtml = '';
            if (meta.mine_overlay_ok === true) {
                mineSyncHtml = `<div style="background:#e8f4ff;color:#0b5cad;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:10px;border:1px solid #b9dbff;">ğŸ”µ <b>æˆ‘çš„è®¢å•åŒæ­¥æ­£å¸¸</b>ï¼šå·²è¯†åˆ« ${Number(meta.mine_slots_count || 0)} ä¸ª mine æ ¼å­ã€‚</div>`;
            } else if (meta.mine_overlay_ok === false) {
                const reason = meta.mine_overlay_error || 'æœªçŸ¥åŸå› ';
                mineSyncHtml = `<div style="background:#f8f9fa;color:#666;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:10px;border:1px solid #ddd;">âš ï¸ <b>æˆ‘çš„è®¢å•åŒæ­¥å¤±è´¥</b>ï¼šmine é¢œè‰²å¯èƒ½ä¸å®Œæ•´ï¼ˆ${reason}ï¼‰ã€‚</div>`;
            }

            const normalizeStatus = (rawStatus, fakeMode) => {
                if (fakeMode) return 'available';
                if (rawStatus === undefined || rawStatus === null) return 'occupied';
                if (typeof rawStatus === 'string') {
                    const s = rawStatus.toLowerCase();
                    if (['available', 'free'].includes(s)) return 'available';
                    if (['locked', 'lock'].includes(s)) return 'locked';
                    if (['mine', 'self', 'my_booked', 'mybooked', 'booked_by_me'].includes(s)) return 'mine';
                    if (['booked', 'occupied', 'reserved'].includes(s)) return 'occupied';
                    return 'occupied';
                }
                if (typeof rawStatus === 'number') {
                    if (rawStatus === 1) return 'available';
                    if (rawStatus === 6) return 'locked';
                    return 'occupied';
                }
                if (typeof rawStatus === 'object') {
                    if (rawStatus.mine || rawStatus.isMine || rawStatus.bookedByMe) return 'mine';
                    const inner = rawStatus.status || rawStatus.state || rawStatus.value;
                    return normalizeStatus(inner, false);
                }
                return 'occupied';
            };

            const statusClassMap = {
                available: 'available',
                locked: 'locked',
                mine: 'mine',
                occupied: 'occupied'
            };

            const isSelectable = (status) => status === 'available';

            latestPlaces = places.map(String);
            latestTimes = times.slice();
            latestCellStatus = {};

            const legendHtml = `
                <div class="matrix-legend">
                    <span class="legend-item"><span class="legend-dot" style="background:#34c759"></span>ç©ºé—²</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#8e8e93"></span>é”å®š</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#5ac8fa"></span>æˆ‘çš„å·²é¢„è®¢</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#ff3b30"></span>ä»–äººå·²é¢„è®¢</span>
                </div>`;

            let tableHtml = '<div class="matrix-table-view"><table><thead><tr><th>æ—¶é—´ \\ åœºåœ°</th>';
            places.forEach(p => tableHtml += `<th>${p}å·</th>`);
            tableHtml += '</tr></thead><tbody>';
            times.forEach(t => {
                tableHtml += `<tr><td>${t}</td>`;
                places.forEach(p => {
                    const status = normalizeStatus(matrix[p]?.[t], isFakeMode);
                    const key = `${p}|${t}`;
                    const isSel = selectedItems.has(key) ? 'selected' : '';
                    const cssClass = statusClassMap[status] || 'occupied';
                    latestCellStatus[key] = status;
                    if (!isSelectable(status) && isSel) {
                        selectedItems.delete(key);
                    }

                    if (isSelectable(status)) {
                        tableHtml += `<td><div class="cell ${cssClass} ${isSel}" data-key="${key}" onclick="toggleCell(this, '${p}', '${t}')"></div></td>`;
                    } else {
                        tableHtml += `<td><div class="cell ${cssClass}" title="${status === 'mine' ? 'æˆ‘çš„å·²é¢„è®¢' : status === 'locked' ? 'é”å®šä¸­' : 'å·²è¢«é¢„è®¢'}"></div></td>`;
                    }
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table></div>';

            let cardHtml = '<div class="matrix-card-view">';
            times.forEach(t => {
                cardHtml += `<div class="time-card"><div class="time-card-title">${t}</div><div class="time-card-grid">`;
                places.forEach(p => {
                    const status = normalizeStatus(matrix[p]?.[t], isFakeMode);
                    const key = `${p}|${t}`;
                    const isSel = selectedItems.has(key) ? 'selected' : '';
                    const cssClass = statusClassMap[status] || 'occupied';
                    latestCellStatus[key] = status;
                    if (!isSelectable(status) && isSel) {
                        selectedItems.delete(key);
                    }

                    if (isSelectable(status)) {
                        cardHtml += `<button class="place-pill ${cssClass} ${isSel} cell" data-key="${key}" onclick="toggleCell(this, '${p}', '${t}')">${p}å·</button>`;
                    } else {
                        const mark = status === 'mine' ? 'æˆ‘' : status === 'locked' ? 'é”' : 'å ';
                        cardHtml += `<button class="place-pill ${cssClass}" disabled title="${status === 'mine' ? 'æˆ‘çš„å·²é¢„è®¢' : status === 'locked' ? 'é”å®šä¸­' : 'å·²è¢«é¢„è®¢'}">${p}å·Â·${mark}</button>`;
                    }
                });
                cardHtml += '</div></div>';
            });
            cardHtml += '</div>';

            document.getElementById('matrix-area').innerHTML = `<div class="matrix-container">${statusHtml}${mineSyncHtml}${legendHtml}${tableHtml}${cardHtml}</div>`;
            updateBar();
        }

        function isValidSemiAutoSelection(nextSelectedSet) {
            if (nextSelectedSet.size === 0) return true;

            const placeSet = new Set();
            const timeSet = new Set();
            nextSelectedSet.forEach(key => {
                const [p, t] = key.split('|');
                placeSet.add(String(p));
                timeSet.add(String(t));
            });

            if (placeSet.size > 3 || timeSet.size > 3) return false;

            const placeIndices = Array.from(placeSet).map(p => latestPlaces.indexOf(String(p))).filter(i => i >= 0).sort((a, b) => a - b);
            const timeIndices = Array.from(timeSet).map(t => latestTimes.indexOf(String(t))).filter(i => i >= 0).sort((a, b) => a - b);

            if (placeIndices.length !== placeSet.size || timeIndices.length !== timeSet.size) return false;

            const minPi = placeIndices[0], maxPi = placeIndices[placeIndices.length - 1];
            const minTi = timeIndices[0], maxTi = timeIndices[timeIndices.length - 1];

            if (maxPi - minPi + 1 > 3 || maxTi - minTi + 1 > 3) return false;

            for (let ti = minTi; ti <= maxTi; ti++) {
                for (let pi = minPi; pi <= maxPi; pi++) {
                    const key = `${latestPlaces[pi]}|${latestTimes[ti]}`;
                    if (nextSelectedSet.has(key)) continue;
                    const status = latestCellStatus[key] || 'occupied';
                    if (status === 'available') {
                        return false;
                    }
                }
            }

            return true;
        }

        function toggleCell(el, place, time) {
            const key = `${place}|${time}`;
            if (selectedItems.has(key)) {
                selectedItems.delete(key);
            } else {
                // é™åˆ¶æ ¡éªŒ
                let timeCount = 0; selectedItems.forEach(k => { if (k.startsWith(place + '|')) timeCount++; });
                // if (timeCount >= 3) return alert(`âš ï¸ é™åˆ¶ï¼šå•ä¸ªåœºåœ°æœ€å¤š3å°æ—¶`);

                let placeCount = 0; selectedItems.forEach(k => { if (k.endsWith('|' + time)) placeCount++; });
                // if (placeCount >= 3) return alert(`âš ï¸ é™åˆ¶ï¼šåŒæ—¶æ®µæœ€å¤š3å—åœºåœ°`);

                // å…¨å±€é™åˆ¶ï¼šæ€»æ•°ä¸è¶…è¿‡ 3 å— (ä¸´æ—¶æ”¾å®½åˆ° 9 å—ä»¥æ”¯æŒ 3x3 çŸ©é˜µ?)
                // ç”¨æˆ·è¯´ "æœ€å¤šé€‰ 3x3"ï¼Œæ„æ€æ˜¯ 3ä¸ªåœºåœ° x 3ä¸ªæ—¶æ®µ = 9ä¸ªæ ¼å­ï¼Ÿ
                // æˆ–è€…æ˜¯ä¹‹å‰çš„è§„åˆ™ï¼šåŒåœºåœ°æœ€å¤š3å°æ—¶ï¼ŒåŒæ—¶æ®µæœ€å¤š3åœºåœ°ã€‚
                // å¦‚æœç”¨æˆ·æƒ³ä¸€æ¬¡æ€§é€‰å¾ˆå¤šç„¶åæ‰¹é‡ä¸‹å•ï¼Œæˆ‘ä»¬è¿™é‡Œæš‚æ—¶æ”¾å®½å‰ç«¯é™åˆ¶ï¼Œ
                // ä½†è¦æç¤ºç”¨æˆ·å¦‚æœè¶…è¿‡é™åˆ¶å¯èƒ½ä¼šè¢«ç³»ç»Ÿæ‹’ç»ã€‚
                // ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¿ç•™ä¹‹å‰çš„ 3x3 é€»è¾‘ï¼Œä½†å¦‚æœç”¨æˆ·è¯´â€œä¸è¡Œâ€ï¼Œå¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬ä¹‹å‰çš„é™åˆ¶å¡ä½äº†ä»–é€‰æ›´å¤šï¼Ÿ
                // æˆ–è€…æ˜¯â€œå¼ºåˆ¶å¯é€‰â€å¯¼è‡´çŠ¶æ€é”™ä¹±ï¼Ÿ

                // é‡æ–°å®¡è§†ç”¨æˆ·éœ€æ±‚ï¼š"æœ€å¤šé€‰ 3x3... è¿™æ ·ä¸‹å•æ‰æœ‰æ•ˆ"
                // è¿™æ„å‘³ç€å¿…é¡»éµå®ˆ 3x3 è§„åˆ™ã€‚

                if (timeCount >= 3) return alert(`âš ï¸ é™åˆ¶ï¼šå•ä¸ªåœºåœ°æœ€å¤šåªèƒ½è¿ç»­è®¢ 3 ä¸ªå°æ—¶ï¼`);
                if (placeCount >= 3) return alert(`âš ï¸ é™åˆ¶ï¼šåŒä¸€ä¸ªæ—¶é—´æ®µæœ€å¤šåªèƒ½è®¢ 3 å—åœºåœ°ï¼`);

                const nextSet = new Set(selectedItems);
                nextSet.add(key);
                if (!isValidSemiAutoSelection(nextSet)) {
                    return alert(`âš ï¸ é™åˆ¶ï¼šåŠè‡ªåŠ¨æŠ¢ç¥¨éœ€æ»¡è¶³ 3x3 è§„åˆ™ï¼ˆè¿ç»­åœºåœ°å· + è¿ç»­æ—¶é—´æ®µï¼›å¯ä¸å·²è¢«é¢„è®¢æ ¼å­ç»„åˆæˆ 3x3ï¼‰ã€‚`);
                }

                selectedItems.add(key);
            }
            document.querySelectorAll(`.cell[data-key="${key}"]`).forEach(node => node.classList.toggle('selected', selectedItems.has(key)));
            updateBar();
        }

        function updateBar() {
            const count = selectedItems.size;
            document.getElementById('count').innerText = count;
            // ç§»é™¤ä¸å­˜åœ¨çš„å…ƒç´ è°ƒç”¨
            // document.getElementById('taskSelCount').innerText = count; 
            const hasItem = count > 0;

            const btnNow = document.getElementById('btnNow');
            const btnTimer = document.getElementById('btnTimer');

            if (btnNow) btnNow.disabled = !hasItem;

            // åªæœ‰å½“å®šæ—¶æŠ¢ç¥¨è¢«å‹¾é€‰æ—¶ï¼Œæ‰æ“ä½œ btnTimer
            if (document.getElementById('timerEnable').checked) {
                if (btnTimer) btnTimer.disabled = !hasItem;
            }

            const tagContainer = document.getElementById('tagList');
            if (!tagContainer) return;

            tagContainer.innerHTML = '';
            const sortedKeys = Array.from(selectedItems).sort((a, b) => {
                const [p1, t1] = a.split('|');
                const [p2, t2] = b.split('|');
                if (Number(p1) !== Number(p2)) return Number(p1) - Number(p2);
                return t1.localeCompare(t2);
            });
            sortedKeys.forEach(key => {
                const [place, time] = key.split('|');
                const [h, m] = time.split(':');
                const nextH = parseInt(h) + 1;
                const timeRange = `${time}-${String(nextH).padStart(2, '0')}:00`;

                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `<span>${place}å· ${timeRange}</span><span class="tag-close" onclick="removeTag('${key}')">Ã—</span>`;
                tagContainer.appendChild(tag);
            });
        }

        function removeTag(key) {
            if (selectedItems.has(key)) {
                selectedItems.delete(key);
                document.querySelectorAll(`.cell[data-key="${key}"]`).forEach(node => node.classList.remove('selected'));
                updateBar();
            }
        }

        function toggleTimer() {
            const enabled = document.getElementById('timerEnable').checked;
            const input = document.getElementById('timerInput');
            input.disabled = !enabled;

            // å¦‚æœå¯ç”¨ä¸”ä¸ºç©ºï¼Œé»˜è®¤è®¾ç½®ä¸ºæ˜å¤©æ—©8ç‚¹
            if (enabled && !input.value) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(8, 0, 0, 0);
                // datetime-local æ ¼å¼: YYYY-MM-DDTHH:mm
                const y = tomorrow.getFullYear();
                const m = String(tomorrow.getMonth() + 1).padStart(2, '0');
                const d = String(tomorrow.getDate()).padStart(2, '0');
                input.value = `${y}-${m}-${d}T08:00`;
            }

            document.getElementById('btnNow').style.display = enabled ? 'none' : 'block';
            document.getElementById('btnTimer').style.display = enabled ? 'block' : 'none';
            if (!enabled) stopTimer();
        }

        function startTimer() {
            if (selectedItems.size === 0) return alert("è¯·å…ˆé€‰æ‹©åœºåœ°ï¼");
            isTimerRunning = true;
            document.getElementById('btnTimer').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';
            document.getElementById('timerInput').disabled = true;
            document.getElementById('timerEnable').disabled = true;
            document.querySelectorAll('.cell').forEach(c => c.style.pointerEvents = 'none');
        }

        function stopTimer() {
            isTimerRunning = false;
            document.getElementById('btnTimer').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
            document.getElementById('timerInput').disabled = false;
            document.getElementById('timerEnable').disabled = false;
            document.getElementById('countdown').innerText = "";
            document.querySelectorAll('.cell').forEach(c => c.style.pointerEvents = 'auto');
        }

        async function submitOrder(isAuto) {
            if (selectedItems.size === 0) return;
            if (!isAuto && !confirm(`ç¡®è®¤è¦é¢„å®šè¿™ ${selectedItems.size} ä¸ªåœºåœ°å—ï¼Ÿ`)) return;

            const btn = isAuto ? null : document.getElementById('btnNow');
            if (btn) { btn.disabled = true; btn.innerText = "æäº¤ä¸­..."; }

            const toast = document.createElement('div');
            toast.style.cssText = [
                "position:fixed",
                "top:20px",
                "left:50%",
                "transform:translateX(-50%)",
                "background:rgba(0,0,0,0.8)",
                "color:white",
                "padding:15px 30px",
                "border-radius:30px",
                "z-index:9999"
            ].join(";");
            toast.innerText = isAuto ? "â° æ—¶é—´åˆ°ï¼æ­£åœ¨è‡ªåŠ¨æŠ¢ç¥¨..." : "ğŸš€ æ­£åœ¨æäº¤è®¢å•...";
            document.body.appendChild(toast);

            const items = Array.from(selectedItems).map(key => {
                const [place, time] = key.split('|');
                return { place, time };
            });

            try {
                // å…³é”®ä¿®æ”¹ï¼šæ— è®ºæ‰‹åŠ¨è¿˜æ˜¯è‡ªåŠ¨ï¼Œæ¯æ¬¡åªå‘ 1 ä¸ª /api/book è¯·æ±‚
                const resp = await fetch('/api/book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: currentDate, items })
                });

                const result = await resp.json();
                document.body.removeChild(toast);

                if (result.status === 'success' || result.status === 'partial') {
                    const msg = result.status === 'success'
                        ? 'ğŸ‰ æŠ¢ç¥¨æˆåŠŸå–µï¼'
                        : 'ğŸ‰ æŠ¢ç¥¨éƒ¨åˆ†æˆåŠŸå–µï¼';
                    alert(msg);
                    loadMatrix(currentDate);
                    selectedItems.clear();
                    updateBar();
                    if (isAuto) stopTimer();
                } else {
                    alert('âŒ å¤±è´¥: ' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                document.body.removeChild(toast);
                alert('ç½‘ç»œé”™è¯¯');
            } finally {
                if (btn) { btn.disabled = false; btn.innerText = "ç«‹å³ä¸‹å•"; }
            }
        }


        // === ä»»åŠ¡ç®¡ç† JS ===

        function openTaskManager() {
            document.getElementById('taskModal').style.display = 'flex';
            initDateSelector();
            initPlaceSelector();
            initTimeSelector();
            loadTasks();
            loadConfig(); // åŠ è½½é…ç½®
            updateTaskSummary();
        }

                async function loadConfig() {
                    try {
                        const res = await fetch('/api/config');
                        const config = await res.json();

                        // å…¨å±€æŠ¥è­¦æ‰‹æœºå· -> å¡«åˆ° globalNotificationPhones
                        if (config.notification_phones) {
                            const el = document.getElementById('globalNotificationPhones');
                            if (el) {
                                el.value = (config.notification_phones || []).join(', ');
                            }
                        }
                        if (config.pushplus_tokens) {
                            const el = document.getElementById('globalPushplusTokens');
                            if (el) {
                                el.value = (config.pushplus_tokens || []).join(', ');
                            }
                        }

                        if (config.retry_interval != null) {
                            document.getElementById('retryInterval').value = config.retry_interval;
                        }

                        if (config.aggressive_retry_interval != null) {
                            document.getElementById('aggressiveRetryInterval').value =
                                config.aggressive_retry_interval;
                        }

                        if (config.locked_retry_interval != null) {
                            document.getElementById('lockedRetryInterval').value =
                                config.locked_retry_interval;
                        }

                        if (config.locked_max_seconds != null) {
                            document.getElementById('lockedMaxSeconds').value =
                                config.locked_max_seconds;
                        }

                        // âœ… å¥åº·æ£€æŸ¥é…ç½®
                        if (config.health_check_enabled != null) {
                            const chk = document.getElementById('healthCheckEnabled');
                            if (chk) chk.checked = !!config.health_check_enabled;
                        }
                        if (config.health_check_interval_min != null) {
                            const inp = document.getElementById('healthCheckInterval');
                            if (inp) inp.value = config.health_check_interval_min;
                        }
                        if (config.health_check_start_time != null) {
                            const inp = document.getElementById('healthCheckStartTime');
                            if (inp) inp.value = config.health_check_start_time;
                        }
                    } catch (e) {
                        console.error('åŠ è½½é…ç½®å¤±è´¥', e);
                    }
                }


        async function checkToken() {
            try {
                const res = await fetch('/api/config/check-token', { method: 'POST' });
                const data = await res.json();

                const queryLine = `æŸ¥è¯¢é“¾è·¯ï¼š${data.query_auth_ok ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}ï¼ˆ${data.query_auth_msg || 'æ— è¯¦æƒ…'}ï¼‰`;
                let bookingLine = '';
                if (data.booking_auth_ok && data.booking_auth_unknown) {
                    bookingLine = `ä¸‹å•é“¾è·¯ï¼šâš ï¸ å·²æ¢æµ‹ä½†æœªç¡®è®¤ï¼ˆ${data.booking_auth_msg || 'æ— è¯¦æƒ…'}ï¼‰`;
                } else if (data.booking_auth_ok) {
                    bookingLine = `ä¸‹å•é“¾è·¯ï¼šâœ… é€šè¿‡ï¼ˆ${data.booking_auth_msg || 'æ— è¯¦æƒ…'}ï¼‰`;
                } else if (data.booking_auth_unknown) {
                    bookingLine = `ä¸‹å•é“¾è·¯ï¼šâš ï¸ æ¢æµ‹å¼‚å¸¸/æœªçŸ¥ï¼ˆ${data.booking_auth_msg || 'æ— è¯¦æƒ…'}ï¼‰`;
                } else {
                    bookingLine = `ä¸‹å•é“¾è·¯ï¼šâŒ ç–‘ä¼¼é‰´æƒå¤±è´¥ï¼ˆ${data.booking_auth_msg || 'æ— è¯¦æƒ…'}ï¼‰`;
                }

                const caution = 'æç¤ºï¼šæŸ¥è¯¢é€šè¿‡ â‰  ä¸€å®šä¸‹å•æˆåŠŸï¼›ä¸‹å•è¿˜å¯èƒ½å— cookieã€é£æ§ã€æ—¶æœºã€å¹¶å‘æŠ¢å å½±å“ã€‚';
                const prefix = data.status === 'success' ? 'âœ… ' : 'âŒ ';
                const smsTip = data.status === 'success' ? '' : '\n\nå¦‚æœå·²é…ç½®æ‰‹æœºå·ï¼Œç³»ç»Ÿå°è¯•å‘é€äº†æŠ¥è­¦çŸ­ä¿¡ã€‚';
                alert(prefix + (data.msg || 'å‡­è¯æ£€æŸ¥å®Œæˆ') + `\n\n${queryLine}\n${bookingLine}\n\n${caution}` + smsTip);
            } catch (e) {
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            }
        }

        async function updateAuth() {
            const token = document.getElementById('newToken').value.trim();
            const cookie = document.getElementById('newCookie').value.trim();
            if (!token) return alert("è¯·è‡³å°‘å¡«å†™ Token");

            try {
                const body = { token };
                if (cookie) body.cookie = cookie;
                const res = await fetch('/api/config/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert('âœ… ' + data.msg);
                    document.getElementById('authUpdateArea').style.display = 'none';
                    // é‡æ–°æ£€æŸ¥ä¸€ä¸‹
                    checkToken();
                } else {
                    alert('âŒ æ›´æ–°å¤±è´¥: ' + data.msg);
                }
            } catch (e) { alert('æ›´æ–°å¤±è´¥'); }
        }

        async function saveConfig(showTip = true) {
            try {
                const globalNotificationPhones = document
                    .getElementById('globalNotificationPhones')
                    .value.split(/[,ï¼Œ]/)
                    .map(s => s.trim())
                    .filter(Boolean);
                const globalPushplusTokens = document
                    .getElementById('globalPushplusTokens')
                    .value.split(/[,ï¼Œ]/)
                    .map(s => s.trim())
                    .filter(Boolean);

                const retryInterval = parseFloat(document.getElementById('retryInterval').value);
                const aggressiveRetryInterval = parseFloat(document.getElementById('aggressiveRetryInterval').value);
                const lockedRetryInterval = parseFloat(document.getElementById('lockedRetryInterval').value);
                const lockedMaxSeconds = parseFloat(document.getElementById('lockedMaxSeconds').value);

                // è·å–å¥åº·æ£€æŸ¥å­—æ®µ
                const healthEnabledEl = document.getElementById('healthCheckEnabled');
                const healthIntervalEl = document.getElementById('healthCheckInterval');
                const healthStartEl = document.getElementById('healthCheckStartTime');

                const body = {
                    notification_phones: globalNotificationPhones,
                    pushplus_tokens: globalPushplusTokens,
                    retry_interval: isNaN(retryInterval) ? 1.0 : retryInterval,
                    aggressive_retry_interval: isNaN(aggressiveRetryInterval) ? 0.3 : aggressiveRetryInterval,
                    locked_retry_interval: isNaN(lockedRetryInterval) ? 1.0 : lockedRetryInterval,
                    locked_max_seconds: isNaN(lockedMaxSeconds) ? 60.0 : lockedMaxSeconds,
                };

                // å¥åº·æ£€æŸ¥å­—æ®µ
                if (healthEnabledEl) {
                    body.health_check_enabled = !!healthEnabledEl.checked;
                }
                if (healthIntervalEl) {
                    const h = parseFloat(healthIntervalEl.value);
                    if (!isNaN(h)) body.health_check_interval_min = h;
                }
                if (healthStartEl && healthStartEl.value) {
                    body.health_check_start_time = healthStartEl.value;
                }

                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });

                const result = await res.json();
                if (result.status === 'success') {
                    if (showTip) showToast('ä¿å­˜æˆåŠŸ');
                } else {
                    if (showTip) showToast('ä¿å­˜å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'), true);
                }
            } catch (e) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥', e);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—', true);
            }
        }




        async function testSMS() {
            const phones = document.getElementById('globalNotificationPhones').value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            if (phones.length === 0) return alert('è¯·å…ˆè¾“å…¥æ‰‹æœºå·');

            try {
                const res = await fetch('/api/config/test-sms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phones })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert('âœ… ' + data.msg);
                } else {
                    alert('âŒ ' + data.msg);
                }
            } catch (e) {
                console.error(e);
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
            }
        }

        function parseTaskTime() {
            const timeVal = (document.getElementById('taskTime')?.value || '00:00:00').trim();
            const parts = timeVal.split(':');
            const hh = parseInt(parts[0] || '0', 10);
            const mm = parseInt(parts[1] || '0', 10);
            const ss = parseInt(parts[2] || '0', 10);
            return {
                hh: Number.isNaN(hh) ? 0 : hh,
                mm: Number.isNaN(mm) ? 0 : mm,
                ss: Number.isNaN(ss) ? 0 : ss,
            };
        }

        function calcNextRunFromCurrentForm() {
            const now = new Date();
            const type = document.getElementById('taskType')?.value || 'daily';
            const { hh, mm, ss } = parseTaskTime();

            const nextRun = new Date(now.getTime());
            nextRun.setHours(hh, mm, ss, 0);

            if (type === 'weekly') {
                const weeklyDayVal = parseInt(document.getElementById('weeklyDay')?.value || '0', 10);
                const targetWeekday = Number.isNaN(weeklyDayVal) ? 0 : weeklyDayVal; // 0=å‘¨ä¸€..6=å‘¨æ—¥
                const todayJs = now.getDay(); // 0=å‘¨æ—¥..6=å‘¨å…­
                const todayOur = (todayJs + 6) % 7; // 0=å‘¨ä¸€..6=å‘¨æ—¥

                let diff = targetWeekday - todayOur;
                if (diff < 0 || (diff === 0 && nextRun <= now)) {
                    diff += 7;
                }
                nextRun.setDate(now.getDate() + diff);
                nextRun.setHours(hh, mm, ss, 0);
                return nextRun;
            }

            // daily / onceï¼šè‹¥ä»Šå¤©è¯¥æ—¶é—´å·²è¿‡ï¼Œåˆ™ä¸‹ä¸€æ¬¡æ˜¯æ˜å¤©
            if (nextRun <= now) {
                nextRun.setDate(nextRun.getDate() + 1);
            }
            return nextRun;
        }

        function updateTaskDateSelector() {
            const container = document.getElementById('targetDateList');
            if (!container) return;

            const selectedOffset = parseInt(document.getElementById('taskOffset')?.value || '2', 10);
            const validSelectedOffset = Number.isNaN(selectedOffset) ? 2 : selectedOffset;
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const baseDate = calcNextRunFromCurrentForm();

            container.innerHTML = '';

            for (let i = 0; i < 14; i++) {
                const d = new Date(baseDate.getTime());
                d.setDate(d.getDate() + i);

                const month = d.getMonth() + 1;
                const day = d.getDate();
                const dateStr = `${month}/${day}`;
                const weekStr = weekdays[d.getDay()];
                const offsetLabel = `+${i}å¤©`;
                const detailLabel = `${dateStr} ${weekStr}`;

                const btn = document.createElement('div');
                btn.style.cssText = `
                    padding:6px;
                    border:1px solid #ddd;
                    border-radius:6px;
                    cursor:pointer;
                    text-align:center;
                    font-size:12px;
                    background:white;
                `;
                btn.innerHTML = `
                    <div style="font-weight:bold;color:#333;">${offsetLabel}</div>
                    <div style="color:#666;font-size:11px">${detailLabel}</div>
                `;

                btn.onclick = () => {
                    document.querySelectorAll('#targetDateList > div').forEach(b => {
                        b.style.borderColor = '#ddd';
                        b.style.background = 'white';
                        b.style.color = '#333';
                    });
                    btn.style.borderColor = '#007aff';
                    btn.style.background = '#e3f2fd';
                    btn.style.color = '#007aff';

                    document.getElementById('taskOffset').value = i;
                    updateTaskSummary();
                };

                container.appendChild(btn);
            }

            const toSelect = Math.max(0, Math.min(13, validSelectedOffset));
            const defaultBtn = container.children[toSelect] || container.children[2] || container.children[0];
            if (defaultBtn) {
                defaultBtn.click();
            }
        }

        function initDateSelector() {
            updateTaskDateSelector();
        }


        function isContinuousNumbers(values) {
            const sorted = values.map(v => Number(v)).sort((a, b) => a - b);
            if (sorted.length <= 1) return true;
            for (let i = 1; i < sorted.length; i++) {
                if (sorted[i] !== sorted[i - 1] + 1) return false;
            }
            return true;
        }

        function isContinuousTimes(values) {
            const hours = values
                .map(v => Number(String(v).split(':')[0]))
                .sort((a, b) => a - b);
            if (hours.length <= 1) return true;
            for (let i = 1; i < hours.length; i++) {
                if (hours[i] !== hours[i - 1] + 1) return false;
            }
            return true;
        }

        function initPlaceSelector() {
            const container = document.getElementById('placeSelector');
            if (!container) return;

            container.innerHTML = '';

            // ä½¿ç”¨ç¼“å­˜çš„åœºåœ°åˆ—è¡¨ï¼Œå¦‚æœä¸ºç©ºåˆ™å…œåº•æ˜¾ç¤º 1-17
            const placesToRender = (cachedPlaces && cachedPlaces.length > 0)
                ? cachedPlaces
                : Array.from({ length: 17 }, (_, i) => String(i + 1));

            placesToRender.forEach(p => {
                const btn = document.createElement('div');
                btn.className = 'tag-btn';
                btn.innerText = p + "å·";
                btn.dataset.place = String(p);
                btn.onclick = () => {
                    btn.classList.toggle('active');
                    updateTaskSummary();
                };
                container.appendChild(btn);
            });
        }


        function initTimeSelector() {
            const container = document.getElementById('timeSelector');
            if (container.children.length > 0) return;

            // ä¸æœåŠ¡å™¨æœ‰æ•ˆæ—¶æ®µä¿æŒä¸€è‡´ï¼š10:00 - 21:00
            for (let i = 10; i <= 21; i++) {
                const timeStr = String(i).padStart(2, '0') + ":00";
                const btn = document.createElement('div');
                btn.className = 'tag-btn';
                btn.innerText = timeStr;
                btn.onclick = () => {
                    if (!btn.classList.contains('active')) {
                        const activeTimes = Array.from(document.querySelectorAll('#timeSelector .active')).map(n => n.innerText);
                        if (activeTimes.length >= 3) return alert("âš ï¸ é™åˆ¶ï¼šå•ä¸ªåœºåœ°æœ€å¤šåªèƒ½æŠ¢ 3 ä¸ªå°æ—¶ï¼");

                        const nextTimes = [...activeTimes, timeStr];
                        if (!isContinuousTimes(nextTimes)) {
                            return alert("âš ï¸ é™åˆ¶ï¼šæ—¶é—´æ®µå¿…é¡»è¿ç»­ï¼ˆå¦‚ 13:00,14:00ï¼‰ï¼");
                        }
                    }
                    btn.classList.toggle('active');
                    updateTaskSummary();
                };
                container.appendChild(btn);
            }
        }


        function onTaskTypeChange() {
            const type = document.getElementById('taskType').value;
            const weeklyGroup = document.getElementById('weeklyDayGroup');
            if (!weeklyGroup) return;

            if (type === 'weekly') {
                weeklyGroup.style.display = 'block';
                updateTaskDateSelector();
            } else {
                weeklyGroup.style.display = 'none';
                updateTaskDateSelector();
            }
        }


        function updateTaskSummary() {
            // å·²é€‰åœºåœ°å’Œæ—¶é—´
            const selectedPlaces = Array.from(
                document.querySelectorAll('#placeSelector .tag-btn.active')
            ).map(btn => (btn.dataset.place || btn.innerText.replace('å·', '')));

            const selectedTimes = Array.from(
                document.querySelectorAll('#timeSelector .tag-btn.active')
            ).map(btn => btn.innerText);

            // ç›®æ ‡æ•°é‡
            const targetCount = parseInt(document.getElementById('taskTargetCount').value || '0', 10);

            // è®¡ç®—æ‘˜è¦
            let text = '';
            if (selectedPlaces.length && selectedTimes.length) {
                text = `å·²é€‰ <b>${selectedPlaces.length}</b> ä¸ªå€™é€‰åœºåœ° Ã— <b>${selectedTimes.length}</b> ä¸ªæ—¶é—´æ®µï¼Œ` +
                    `ç†è®ºä¸Šæœ€å¤šå¯ä»¥å‡‘å‡º <b>${selectedPlaces.length}</b> å—åœºåœ°ï¼ˆå€™é€‰åœºåœ°å¯å¤šé€‰ï¼›æ—¶é—´æ®µæœ€å¤š3ä¸ªï¼›æ€»ç›®æ ‡æœ€å¤š3å—ï¼‰ã€‚`;
            } else {
                text = 'è¯·å…ˆé€‰æ‹©å€™é€‰åœºåœ°å’Œæ—¶é—´æ®µ';
            }

            // å¥åº·æ£€æŸ¥é…ç½®
            const healthCheckEnabled = document.getElementById('healthCheckEnabled').checked;
            const healthCheckInterval = document.getElementById('healthCheckInterval').value;
            const healthCheckStartTime = document.getElementById('healthCheckStartTime').value || '00:00';

            function predictNextHealthCheck(startTime, intervalMin) {
                const now = new Date();
                const parts = (startTime || '00:00').split(':');
                if (parts.length < 2) return null;
                const start = new Date(now);
                start.setHours(parseInt(parts[0], 10) || 0, parseInt(parts[1], 10) || 0, 0, 0);
                const interval = parseFloat(intervalMin);
                if (!interval || interval <= 0) return null;
                if (now <= start) return start;
                const elapsedMin = (now - start) / 60000;
                const steps = Math.floor(elapsedMin / interval) + 1;
                return new Date(start.getTime() + steps * interval * 60000);
            }

            const nextCheck = predictNextHealthCheck(healthCheckStartTime, healthCheckInterval);
            const nextCheckText = nextCheck
                ? `${nextCheck.getHours().toString().padStart(2, '0')}:${nextCheck.getMinutes().toString().padStart(2, '0')}`
                : 'æœªçŸ¥';

            text += `<br>å¥åº·æ£€æŸ¥ï¼š${healthCheckEnabled ? 'å¯ç”¨' : 'æœªå¯ç”¨'}ï¼Œå¼€å§‹æ—¶é—´ï¼š${healthCheckStartTime}ï¼Œé—´éš”ï¼š${healthCheckInterval} åˆ†é’Ÿï¼Œé¢„è®¡ä¸‹æ¬¡ï¼š${nextCheckText}`;
            text += `<br>æ‰§è¡Œç­–ç•¥ï¼šæ¯æ‰¹æœ€å¤š 3 å—ï¼ˆç¨³å®šæ¨¡å¼ï¼‰`;

            // æ›´æ–°ä»»åŠ¡æ‘˜è¦
            const summaryEl = document.getElementById('taskSummary');
            if (summaryEl) summaryEl.innerHTML = text;
        }




        function closeTaskManager() {
            document.getElementById('taskModal').style.display = 'none';
        }

        async function loadTasks() {
            const list = document.getElementById('taskList');
            if (!list) return;
            list.innerHTML = 'åŠ è½½ä¸­...';
            try {
                const res = await fetch('/api/tasks');
                const tasks = await res.json();
                window.__tasksCache = tasks;
                list.innerHTML = '';
                if (tasks.length === 0) {
                    list.innerHTML = '<div style="text-align:center;color:#999">æš‚æ— ä»»åŠ¡</div>';
                    return;
                }

                const sortedTasks = [...tasks].sort((a, b) => {
                    const diff = Number(b.last_run_at || 0) - Number(a.last_run_at || 0);
                    if (diff !== 0) return diff;
                    return Number(b.id || 0) - Number(a.id || 0);
                });

                sortedTasks.forEach(t => {
                    // 1. é¢‘ç‡æ–‡æ¡ˆï¼ˆæ¯å¤© / æ¯å‘¨å‡  / å•æ¬¡ï¼‰
                    let desc = "";
                    if (t.type === 'daily') {
                        desc = `æ¯å¤© ${t.run_time}`;
                    } else if (t.type === 'weekly') {
                        const weekNames = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
                        const wd = Number(t.weekly_day || 0);
                        desc = `æ¯å‘¨${weekNames[wd]} ${t.run_time}`;
                    } else if (t.type === 'once') {
                        desc = `å•æ¬¡ ${t.run_time}`;
                    } else {
                        desc = `${t.run_time}`;
                    }

                    // 2. è®¡ç®—ã€Œä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¥æœŸã€
                    const now = new Date();
                    const runTimeStr = t.run_time || "00:00:00";
                    const [hhStr, mmStr, ssStr] = runTimeStr.split(':');
                    const hh = parseInt(hhStr || '0', 10);
                    const minute = parseInt(mmStr || '0', 10);   // ç”¨ minute è¡¨ç¤ºâ€œåˆ†é’Ÿâ€
                    const ss = parseInt(ssStr || '0', 10);

                    let nextRun = new Date(now.getTime());
                    nextRun.setHours(hh, minute, ss, 0);

                    if (t.type === 'daily' || t.type === 'once') {
                        // æ¯å¤© / å•æ¬¡ï¼šä»Šå¤©å·²ç»è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œåˆ™ä»æ˜å¤©å¼€å§‹ç®—
                        if (nextRun <= now) {
                            nextRun.setDate(nextRun.getDate() + 1);
                        }
                    } else if (t.type === 'weekly') {
                        // æ¯å‘¨ï¼šæ‰¾åˆ°ä¸‹ä¸€æ¬¡åˆ°è¾¾æŒ‡å®š weekday çš„é‚£ä¸€å¤©
                        // åç«¯ä¿å­˜çš„ weekdayï¼š0=å‘¨ä¸€,...,6=å‘¨æ—¥
                        const targetWeekday = Number(t.weekly_day || 0);

                        // JS çš„ getDay(): 0=å‘¨æ—¥,...,6=å‘¨å…­
                        const jsToday = now.getDay();              // 0..6 (æ—¥..å…­)
                        const ourToday = (jsToday + 6) % 7;        // è½¬æˆ 0..6 (ä¸€..æ—¥)

                        let diff = targetWeekday - ourToday;
                        // å¦‚æœä»Šå¤©å·²ç»è¿‡äº†è§¦å‘æ—¶é—´ï¼Œæˆ–ä»Šå¤©ä¸æ˜¯ç›®æ ‡å‘¨å‡ ï¼Œå°±å¾€åæ¨ä¸€å‘¨
                        if (diff < 0 || (diff === 0 && nextRun <= now)) {
                            diff += 7;
                        }
                        nextRun = new Date(now.getTime());
                        nextRun.setDate(now.getDate() + diff);
                        nextRun.setHours(hh, minute, ss, 0);
                    }

                    // 3. åœ¨ã€Œä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¥æœŸã€åŸºç¡€ä¸Š + offset å¤©ï¼Œå¾—åˆ°çœŸæ­£è¦æŠ¢çš„åœºåœ°æ—¥æœŸ
                    const offset = Number(t.target_day_offset || 0);
                    const targetDate = new Date(nextRun.getTime());
                    targetDate.setDate(targetDate.getDate() + offset);

                    const monthStr = String(targetDate.getMonth() + 1).padStart(2, "0"); // æœˆ
                    const dayStr = String(targetDate.getDate()).padStart(2, "0");        // æ—¥
                    const weekNamesFull = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                    const weekLabel = weekNamesFull[targetDate.getDay()];

                    // 4. å‰ç¼€é‡Œçš„ã€Œå½“å¤© / æ˜å¤© / åå¤© / Nå¤©åã€ä»ç„¶åªæ ¹æ® offset æ¥è¯´
                    let dayPrefix = '';
                    if (offset === 0) dayPrefix = 'å½“å¤©';
                    else if (offset === 1) dayPrefix = 'æ˜å¤©';
                    else if (offset === 2) dayPrefix = 'åå¤©';
                    else dayPrefix = `${offset}å¤©å`;

                    const dayDesc = `${dayPrefix}çš„åœº`;
                    const dateLine = `ğŸ—“ï¸ æ—¥æœŸï¼š(${monthStr}-${dayStr} ${weekLabel})`;

                    // 5. ä»»åŠ¡ç­–ç•¥è¯´æ˜
                    let detail;
                    if (t.config) {
                        if (t.config.mode === 'priority') {
                            const seqStr = t.config.priority_sequences.map(s => `[${s.join('+')}]`).join(', ');
                            const tStr = t.config.target_times.join(',');
                            detail = `ğŸ¯ ç›®æ ‡ï¼š${t.config.target_count}å— (ä¼˜å…ˆçº§)<br>ğŸ”¥ åºåˆ—ï¼š${seqStr}<br>âŒš æ—¶é—´ï¼š${tStr}`;
                        } else {
                            const pStr = (t.config.candidate_places || []).join(',');
                            const tStr = (t.config.target_times || []).join(',');
                            const modeStr = t.config.smart_continuous ? "è¿å·ä¼˜å…ˆ" : "æ™®é€šæ¨¡å¼";
                            const placeLabel = pStr ? `${pStr}å·` : '-';
                            const timeLabel = tStr || '-';
                            detail = `ğŸ¯ ç›®æ ‡ï¼š${t.config.target_count}å— (${modeStr})<br>ğŸ¸ å€™é€‰ï¼š${placeLabel}<br>âŒš æ—¶é—´ï¼š${timeLabel}`;
                        }
                    } else if (t.items) {
                        const itemsStr = t.items.map(i => `${i.place}å·${i.time}`).join(', ');
                        detail = `ğŸ¯ ç›®æ ‡ï¼š${itemsStr}`;
                    } else {
                        detail = "æ•°æ®æ ¼å¼é”™è¯¯";
                    }

                    // 6. å¦‚æœä»»åŠ¡é…ç½®äº†ä¸“å±é€šçŸ¥æ‰‹æœºå·ï¼Œä¹Ÿå±•ç¤ºå‡ºæ¥
                    if (t.notification_phones && t.notification_phones.length > 0) {
                        const phoneStr = t.notification_phones.join(', ');
                        detail += `<br>ğŸ“± é€šçŸ¥æ‰‹æœºï¼š${phoneStr}`;
                    }
                    if (t.pushplus_tokens && t.pushplus_tokens.length > 0) {
                        const tokenStr = t.pushplus_tokens.join(', ');
                        detail += `<br>ğŸ’¬ å¾®ä¿¡é€šçŸ¥ï¼š${tokenStr}`;
                    }
                    if (t.last_run_at) {
                        detail += `<br>ğŸ•’ æœ€è¿‘æ‰§è¡Œï¼š${new Date(Number(t.last_run_at)).toLocaleString('zh-CN', { hour12: false })}`;
                    }

                    // 7. æ¸²æŸ“åˆ°ä»»åŠ¡åˆ—è¡¨é‡Œ
                    const div = document.createElement('div');
                    div.className = 'task-item';
                    div.innerHTML = `
                        <div class="task-main">
                            <div class="task-info"><b>${desc}</b> è‡ªåŠ¨æŠ¢ <b>${dayDesc}</b></div>
                            <div class="task-meta" style="color:#666;margin-top:5px;line-height:1.5;">${dateLine}<br>${detail}</div>
                        </div>
                        <div class="task-actions">
                            <button class="btn-manage" style="background:#007aff;font-size:12px;padding:4px 8px;" onclick="startEditTask('${t.id}')">ç¼–è¾‘</button>
                            <button class="btn-manage" style="background:#5856d6;font-size:12px;padding:4px 8px;" onclick="copyTask('${t.id}')">å¤åˆ¶</button>
                            <button class="btn-manage" style="background:#34c759;font-size:12px;padding:4px 8px;" onclick="runTask('${t.id}')">âš¡ ç«‹å³è¿è¡Œ</button>
                            <button class="btn-del" onclick="deleteTask('${t.id}')">åˆ é™¤</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = 'åŠ è½½å¤±è´¥';
            }
        }



        async function runTask(id) {
            if (!confirm('ç¡®å®šè¦ç«‹å³æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡è¯¥ä»»åŠ¡å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`/api/tasks/${id}/run`, { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') alert('ä»»åŠ¡å·²è§¦å‘ï¼è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—');
                else alert('è§¦å‘å¤±è´¥: ' + data.msg);
            } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        function togglePlaceMode() {
            // ç°åœ¨åªä¿ç•™â€œæ™®é€šå¤šé€‰â€ï¼ŒæŠŠæ™®é€šåŒºåŸŸæ˜¾ç¤ºå‡ºæ¥å³å¯
            const normal = document.getElementById('modeNormal');
            if (normal) normal.style.display = 'block';

            // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šå¦‚æœé¡µé¢ä¸­æ®‹ç•™äº†å…¶ä»–åŒºåŸŸï¼Œå°±å…¨éƒ¨éšè—
            const priority = document.getElementById('modePriority');
            const timePri = document.getElementById('modeTimePriority');
            if (priority) priority.style.display = 'none';
            if (timePri) timePri.style.display = 'none';

            // æ—¶é—´é€‰æ‹©æ°¸è¿œç”¨â€œç‚¹é€‰â€çš„æ–¹å¼
            const timeSelector = document.getElementById('timeSelector');
            const timeRangeArea = document.getElementById('timeRangeArea');
            const normalLabel = document.getElementById('timeLabelNormal');
            const priorityLabel = document.getElementById('timeLabelPriority');

            if (timeSelector) timeSelector.style.display = 'flex';
            if (timeRangeArea) timeRangeArea.style.display = 'none';
            if (normalLabel) normalLabel.style.display = 'block';
            if (priorityLabel) priorityLabel.style.display = 'none';
        }



        async function createTask() {
            const time = document.getElementById('taskTime').value;
            const type = document.getElementById('taskType').value;
            const offset = parseInt(document.getElementById('taskOffset').value || '0', 10);
            const targetCountRaw = parseInt(document.getElementById('taskTargetCount').value || '2', 10);
            const targetCount = Math.min(Math.max(targetCountRaw, 1), 3);

            // 1. æ”¶é›†æ—¶é—´ï¼ˆç”¨æŒ‰é’®é€‰ä¸­çš„ï¼‰
            const times = [];
            document.querySelectorAll('#timeSelector .active').forEach(btn => {
                times.push(btn.innerText);
            });
            if (times.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¶é—´æ®µï¼');
                return;
            }

            // 2. æ”¶é›†åœºåœ°ï¼ˆå€™é€‰æ± ï¼‰
            const places = [];
            document.querySelectorAll('#placeSelector .active').forEach(btn => {
                places.push(btn.innerText.replace('å·', ''));
            });
            if (places.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåœºåœ°ï¼');
                return;
            }

            if (!isContinuousNumbers(places)) {
                alert('å€™é€‰åœºåœ°å¿…é¡»è¿ç»­ï¼ˆå¦‚ 6,7 æˆ– 6,7,8ï¼‰');
                return;
            }
            if (!isContinuousTimes(times)) {
                alert('æ—¶é—´æ®µå¿…é¡»è¿ç»­ï¼ˆå¦‚ 13:00,14:00,15:00ï¼‰');
                return;
            }

            // 3. åªä¿ç•™â€œæ™®é€šæ¨¡å¼â€çš„ config
            const config = {
                mode: 'normal',  // ä¿ç•™å­—æ®µåï¼Œåç«¯æ²¿ç”¨ç°æœ‰é€»è¾‘
                candidate_places: places,
                smart_continuous: document.getElementById('taskSmartMode').checked,
                target_times: times,
                target_count: targetCount
            };

            // 4. é¢‘ç‡å’Œâ€œå‘¨å‡ æ‰§è¡Œâ€
            let weeklyDay = 0;
            if (type === 'weekly') {
                // è¿™é‡Œçš„ select å…ƒç´  id å®é™…å« weeklyDay
                const wdSelect = document.getElementById('weeklyDay');
                weeklyDay = wdSelect ? parseInt(wdSelect.value || '0', 10) : 0;
            }


            // 5. è§£æä»»åŠ¡çº§æ‰‹æœºå·
            const phoneInput = document.getElementById('notificationPhones').value || '';
            const taskPhones = phoneInput
                .split(/[,ï¼Œ]/)
                .map(s => s.trim())
                .filter(s => s);
            const tokenInput = document.getElementById('taskPushplusTokens').value || '';
            const taskPushplusTokens = tokenInput
                .split(/[,ï¼Œ]/)
                .map(s => s.trim())
                .filter(s => s);

            const task = {
                run_time: time,
                type: type,                 // 'once' / 'daily' / 'weekly'
                target_day_offset: offset,  // è¿˜æ˜¯æ²¿ç”¨ N å¤©å
                config: config,
                weekly_day: weeklyDay,
                notification_phones: taskPhones,
                pushplus_tokens: taskPushplusTokens
            };

            try {
                await saveConfig(false);  // ä»ç„¶ä¿å­˜å…¨å±€é…ç½®ï¼ˆé€Ÿåº¦ & å…¨å±€æ‰‹æœºå·ï¼‰
                const isEditing = editingTaskId !== null;
                const resp = await fetch(isEditing ? `/api/tasks/${editingTaskId}` : '/api/tasks', {
                    method: isEditing ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(task)
                });
                const data = await resp.json();
                if (data.status === 'success') {
                    showToast(isEditing ? 'ä¿®æ”¹æˆåŠŸ' : 'ä¿å­˜æˆåŠŸ');
                    editingTaskId = null;
                    const saveBtn = document.getElementById('saveTaskBtn');
                    if (saveBtn) saveBtn.innerText = 'âœ… ä¿å­˜è®¡åˆ’';
                    loadTasks();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                console.error(e);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—', true);
            }
        }


        async function deleteTask(id) {
            if (!confirm('ç¡®å®šåˆ é™¤?')) return;
            await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
            loadTasks();
        }

        function startEditTask(id) {
            const tasks = window.__tasksCache || [];
            const t = tasks.find(x => String(x.id) === String(id));
            if (!t) return alert('ä»»åŠ¡ä¸å­˜åœ¨');

            editingTaskId = String(id);
            document.getElementById('taskTime').value = t.run_time || '08:00:00';
            document.getElementById('taskType').value = t.type || 'daily';
            document.getElementById('weeklyDay').value = String(t.weekly_day || 0);
            onTaskTypeChange();

            const offset = Number(t.target_day_offset || 0);
            document.getElementById('taskOffset').value = String(offset);
            updateTaskDateSelector();
            const dateBtns = document.querySelectorAll('#targetDateList .date-btn');
            const idx = Math.max(0, Math.min(13, offset));
            if (dateBtns[idx]) dateBtns[idx].click();

            const targetCount = Number((t.config && t.config.target_count) || 2);
            document.getElementById('taskTargetCount').value = String(Math.max(1, Math.min(3, targetCount)));
            document.getElementById('taskSmartMode').checked = !!(t.config && t.config.smart_continuous);
            document.getElementById('notificationPhones').value = (t.notification_phones || []).join(', ');
            document.getElementById('taskPushplusTokens').value = (t.pushplus_tokens || []).join(', ');

            document.querySelectorAll('#placeSelector .tag-btn').forEach(btn => btn.classList.remove('active'));
            const places = (t.config && t.config.candidate_places) || [];
            places.forEach(p => {
                const hit = document.querySelector(`#placeSelector .tag-btn[data-place="${String(p)}"]`);
                if (hit) hit.classList.add('active');
            });

            document.querySelectorAll('#timeSelector .tag-btn').forEach(btn => btn.classList.remove('active'));
            const times = (t.config && t.config.target_times) || [];
            times.forEach(ts => {
                const hit = Array.from(document.querySelectorAll('#timeSelector .tag-btn')).find(btn => btn.innerText === String(ts));
                if (hit) hit.classList.add('active');
            });

            const saveBtn = document.getElementById('saveTaskBtn');
            if (saveBtn) saveBtn.innerText = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
            updateTaskSummary();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function copyTask(id) {
            const tasks = window.__tasksCache || [];
            const t = tasks.find(x => String(x.id) === String(id));
            if (!t) return alert('ä»»åŠ¡ä¸å­˜åœ¨');

            const cloned = JSON.parse(JSON.stringify(t));
            delete cloned.id;
            delete cloned.last_run_at;
            try {
                const resp = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cloned)
                });
                const data = await resp.json();
                if (data.status === 'success') {
                    showToast('å¤åˆ¶æˆåŠŸ');
                    loadTasks();
                } else {
                    alert('å¤åˆ¶å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                console.error(e);
                alert('å¤åˆ¶å¤±è´¥: ç½‘ç»œé”™è¯¯');
            }
        }
    </script>

</body>

</html>
